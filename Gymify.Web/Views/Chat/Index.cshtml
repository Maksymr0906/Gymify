@using Gymify.Application.DTOs.Chat
@model List<ChatDto>

@{
    ViewData["Title"] = "Messages";
    var currentUserId = User.FindFirst("UserProfileId")?.Value;
    var openChatId = Context.Request.Query["openChatId"].ToString();
}

<style>
    /* --- 1. GLOBAL LAYOUT & WRAPPER --- */

    /* Обгортка на весь екран (мінус висота хедера ~80px) */
    .ch-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        height: calc(100vh - 80px); 
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Головний контейнер-сітка: Сайдбар (320px) | Чат (все інше) */
    .ch-container {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: 100%;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    /* --- 2. SIDEBAR (ЛІВА КОЛОНКА) --- */

    .ch-sidebar {
        border-right: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
        background: #fcfcfc;
    }

    .ch-sidebar-header {
        height: 70px;
        padding: 0 20px;
        border-bottom: 1px solid #f0f0f0;
        background: #fff;
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }

    .ch-list {
        flex-grow: 1;
        overflow-y: auto;
        /* Кастомний скролбар */
        scrollbar-width: thin;
        scrollbar-color: #ddd transparent;
    }

    /* --- CHAT LIST ITEM --- */
    .ch-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px 20px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #f9f9f9;
        position: relative;
    }

    .ch-item:hover { background-color: #f2f4f7; }

    /* Активний (вибраний) чат */
    .ch-item.active { 
        background-color: #eef7fe; 
    }
    .ch-item.active::before {
        content: ''; 
        position: absolute; 
        left: 0; top: 0; bottom: 0; 
        width: 4px; 
        background-color: #3498db;
    }

    .ch-avatar {
        width: 48px; 
        height: 48px; 
        border-radius: 50%; 
        object-fit: cover;
        border: 1px solid #eee; 
        flex-shrink: 0;
        background-color: #fff;
    }

    .ch-info { 
        flex-grow: 1; 
        overflow: hidden; 
        min-width: 0; /* Важливо для ellipsis */
    }

    .ch-name {
        font-weight: 700; 
        color: #2c3e50; 
        font-size: 0.95rem; 
        margin-bottom: 4px;
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
    }

    .ch-preview {
        font-size: 0.85rem; 
        color: #888;
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
    }

    /* Жирний шрифт для нового повідомлення */
    .ch-preview.new-msg { 
        color: #333; 
        font-weight: 700; 
    }

    .ch-time {
        font-size: 0.7rem; 
        color: #aaa; 
        position: absolute; 
        top: 15px; 
        right: 15px;
    }

    /* --- 3. MAIN AREA (ПРАВА КОЛОНКА) --- */

    .ch-main {
        display: flex;
        flex-direction: column;
        background: white;
        position: relative;
        overflow: hidden;
    }

    /* Заглушка (коли чат не вибрано) */
    .ch-empty {
        position: absolute; 
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        color: #ccc; 
        z-index: 10; 
        background: white;
    }

    /* Хедер чату */
    .ch-header {
        height: 70px;
        padding: 0 25px;
        border-bottom: 1px solid #f0f0f0;
        display: flex; 
        align-items: center; 
        gap: 15px;
        background: #fff;
        z-index: 2;
        flex-shrink: 0;
    }

    /* Клікабельний блок профілю */
    .ch-header-link {
        display: flex; 
        align-items: center; 
        gap: 15px; 
        text-decoration: none; 
        color: inherit;
        transition: opacity 0.2s;
    }
    .ch-header-link:hover { opacity: 0.7; }

    .ch-header-name { font-weight: 700; font-size: 1.1rem; color: #2c3e50; }
    .ch-header-status { font-size: 0.8rem; color: #27ae60; }

    /* --- 4. MESSAGES AREA --- */

    .ch-messages {
        flex-grow: 1;
        padding: 25px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background-color: #fff;
        scrollbar-width: thin;
    }

    /* --- MESSAGE ROW (Аватар + Бульбашка) --- */
    .ch-msg-row {
        display: flex;
        gap: 10px;
        align-items: flex-end; /* Аватарка знизу */
        margin-bottom: 15px;
        max-width: 80%; 
    }

    /* Мої повідомлення (справа) */
    .ch-msg-row.me {
        align-self: flex-end;
        justify-content: flex-end;
        text-align: right;
    }

    /* Чужі повідомлення (зліва) */
    .ch-msg-row.them {
        align-self: flex-start;
        justify-content: flex-start;
        text-align: left;
    }

    /* Аватарка в повідомленні */
    .ch-msg-avatar {
        width: 36px; 
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #eee;
        flex-shrink: 0;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .ch-msg-avatar:hover { transform: scale(1.1); }

    /* Бульбашка з текстом */
    .ch-msg {
        padding: 10px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        text-align: left; /* Текст всередині завжди зліва */
    }

    /* Стилі бульбашки "Я" */
    .ch-msg.me {
        background-color: #3498db;
        color: white;
        border-bottom-right-radius: 4px; /* "Хвостик" */
    }
    .ch-msg.me a { color: #cce5ff; text-decoration: underline; }

    /* Стилі бульбашки "Він" */
    .ch-msg.them {
        background-color: #f1f2f6;
        color: #333;
        border-bottom-left-radius: 4px; /* "Хвостик" */
    }

    .ch-msg-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
        display: block;
    }

    /* --- 5. INPUT AREA --- */

    .ch-input-area {
        padding: 20px;
        border-top: 1px solid #f0f0f0;
        display: flex; 
        gap: 15px; 
        align-items: center;
        background: #fff;
        flex-shrink: 0;
    }

    .ch-input {
        width: 100%;
        padding: 12px 20px;
        border: 1px solid #e0e0e0;
        border-radius: 24px;
        background-color: #f9f9f9;
        font-size: 0.95rem;
        outline: none;
        transition: all 0.2s;
    }
    .ch-input:focus { 
        background-color: #fff; 
        border-color: #3498db; 
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Кнопка відправки */
    .ch-btn-send {
        width: 45px; height: 45px; 
        border-radius: 50%; 
        border: none;
        background-color: #3498db; 
        color: white;
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer;
        transition: transform 0.1s, background-color 0.2s;
        flex-shrink: 0;
        font-size: 1.1rem;
    }
    .ch-btn-send:hover { background-color: #2980b9; transform: scale(1.05); }
    .ch-btn-send:active { transform: scale(0.95); }

    /* Мобільна кнопка "Назад" */
    .ch-btn-back {
        background: none; 
        border: 1px solid #ddd; 
        border-radius: 8px;
        padding: 6px 12px; 
        cursor: pointer; 
        color: #555;
        margin-right: 10px; 
        display: none; /* Ховаємо на десктопі */
    }

    /* Додатково: Стилі для меню дій */
    .ch-msg-actions { 
        opacity: 0; transition: opacity 0.2s; margin-right: 10px;
        align-self: center; display: flex; gap: 5px;
    }
    .ch-msg-row:hover .ch-msg-actions { opacity: 1; }

    .ch-action-btn {
        background: none; border: none; color: #999; cursor: pointer; font-size: 0.85rem;
    }
    .ch-action-btn:hover { color: #3498db; }
    .ch-action-btn.del:hover { color: #e74c3c; }

    /* Позначка "відредаговано" */
    .ch-edited-mark { font-size: 0.65rem; font-style: italic; opacity: 0.6; margin-left: 5px; }

    /* Утиліта для приховування */
    .hidden { display: none !important; }

    /* Анімація появи повідомлення */
    @Html.Raw("@keyframes msgPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }")

    /* --- 6. MOBILE RESPONSIVENESS --- */
    @Html.Raw("@media (max-width: 768px) { .ch-container { grid-template-columns: 1fr; } .ch-main { display: none; width: 100%; height: 100%; } .ch-main.active { display: flex; position: fixed; top: 0; left: 0; z-index: 1000; } .ch-sidebar { width: 100%; } .ch-btn-back { display: block; } .ch-wrapper { padding: 0; height: calc(100vh - 60px); } .ch-container { border: none; border-radius: 0; } }")
</style>

<div class="ch-wrapper">
    <div class="ch-container">
        <div class="ch-sidebar">
            <div class="ch-sidebar-header">
                <input type="text" class="ch-input" placeholder="Search chats..." />
            </div>

            <div class="ch-list" id="chatList">
                @if (Model != null && Model.Any())
                {
                    foreach (var chat in Model)
                    {
                                <div class="ch-item" 
                                     id="chat-item-@chat.ChatId"
                                     onclick="openChat('@chat.ChatId', '@chat.ChatName', '@chat.ChatAvatarUrl', '@chat.TargetUserId', this)">

                                    <img src="@chat.ChatAvatarUrl" class="ch-avatar" alt="Avatar" />

                                    <div class="ch-info">
                                        <div class="ch-name">@chat.ChatName</div>

                                        <div class="ch-preview" id="preview-@chat.ChatId">
                                    @(string.IsNullOrEmpty(chat.LastMessageContent) ? "No messages yet" : chat.LastMessageContent)
                                        </div>
                                    </div>

                            @if (chat.LastMessageTime.HasValue)
                            {
                                            <div class="ch-time">
                                    @chat.LastMessageTime.Value.ToString("dd.MM.yyyy HH:mm")
                                            </div>
                            }
                                </div>
                    }
                }
                else
                {
                        <div style="padding:20px; text-align:center; color:#999;">No chats yet.</div>
                }
            </div>
        </div>

        <div class="ch-main" id="chatMainArea">
            <div id="chatPlaceholder" class="ch-empty">
                <i class="fa-regular fa-comments" style="font-size:4rem; margin-bottom:20px; opacity:0.2;"></i>
                <p>Select a chat</p>
            </div>

            <div id="chatHeader" class="ch-header hidden">
                <button class="ch-btn-back" id="backBtn" onclick="closeChatMobile()"><i class="fa-solid fa-arrow-left"></i></button>
                <a href="#" id="headerLink" class="ch-header-link" style="display: flex; align-items: center; gap: 15px; text-decoration: none; color: inherit;">
                    <img id="headerAvatar" src="" class="ch-avatar" style="width:40px; height:40px;">
                    <div>
                        <div id="headerName" class="ch-header-name">User</div>
                        <div class="ch-header-status; hidden">Online</div>
                    </div>
                </a>
            </div>

            <div id="messagesArea" class="ch-messages hidden"></div>

            <div id="inputArea" class="ch-input-area hidden">
                <button id="cancelEditBtn" class="ch-btn-back hidden" onclick="cancelEditMode()" style="margin-right:10px; display:none;">
                    <i class="fa-solid fa-xmark"></i>
                </button>

                <input type="text" id="msgInput" class="ch-input" placeholder="Type a message..." autocomplete="off" />
                
                <button class="ch-btn-send" id="sendBtn" onclick="sendMessage()">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentChatId = null;
        const currentUserId = "@currentUserId";
        
        // Змінна для режиму редагування
        let editingMessageId = null;

        // UI Elements
        const messagesArea = document.getElementById('messagesArea');
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        // --- 1. SIGNALR ---
        const chatConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        // Нове повідомлення
        chatConnection.on("ReceiveMessage", function (msg) {
            if (currentChatId && currentChatId.toLowerCase() === msg.chatId.toLowerCase()) {
                appendMessage(msg);
                scrollToBottom();
            }

            updateSidebarPreview(msg.chatId, msg.content, msg.createdAt);
        });

        // 👇 ПОВІДОМЛЕННЯ ВІДРЕДАГОВАНО 👇
        chatConnection.on("MessageEdited", function (msg) {
            // Якщо ми в цьому чаті - оновлюємо текст в DOM
            if (currentChatId && currentChatId.toLowerCase() === msg.chatId.toLowerCase()) {
                const contentDiv = document.getElementById(`content-${msg.id}`);
                if (contentDiv) {
                    contentDiv.innerText = msg.content;
                }
            }
        });

        // 👇 ПОВІДОМЛЕННЯ ВИДАЛЕНО 👇
        chatConnection.on("MessageDeleted", function (msgId) {
            const row = document.getElementById(`row-${msgId}`);
            if (row) {
                // Анімація зникнення
                row.style.transition = "opacity 0.3s, height 0.3s";
                row.style.opacity = "0";
                setTimeout(() => row.remove(), 300);
            }
        });

        chatConnection.start().catch(err => console.error(err));

        // ... (Auto Open & Search Logic - без змін) ...
        document.addEventListener("DOMContentLoaded", () => {
             const autoOpenId = "@openChatId";
             if (autoOpenId) {
                 const item = document.getElementById(`chat-item-${autoOpenId}`);
                 if(item) item.click();
             }
        });
        
        // --- FUNCTIONS ---

        // Оновлена функція: приймає dateStr
        function updateSidebarPreview(chatId, text, dateStr) {
            const preview = document.getElementById(`preview-${chatId}`);
            if (preview) {
                // 1. Оновлюємо текст
                preview.innerText = text;
                preview.classList.add("new-msg");

                // 2. Знаходимо елемент чату
                const chatItem = document.getElementById(`chat-item-${chatId}`);

                if (chatItem) {
                    // 3. Форматуємо дату (так само, як у повідомленнях)
                    const dateObj = new Date(dateStr);
                    const timeFormatted = dateObj.toLocaleString('uk-UA', { 
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    }).replace(',', '');

                    // 4. Шукаємо блок часу
                    let timeDiv = chatItem.querySelector('.ch-time');

                    if (timeDiv) {
                        // Якщо блок вже є - просто міняємо текст
                        timeDiv.innerText = timeFormatted;
                    } else {
                        // Якщо це перше повідомлення і блоку часу ще не було - створюємо його
                        // (Вставляємо перед кінцем chatItem)
                        const newTimeDiv = document.createElement('div');
                        newTimeDiv.className = 'ch-time';
                        newTimeDiv.innerText = timeFormatted;
                        chatItem.appendChild(newTimeDiv);
                    }

                    // 5. Піднімаємо чат нагору
                    const list = document.getElementById('chatList');
                    if (list) list.prepend(chatItem);
                }
            }
        }

        async function openChat(chatId, name, avatarUrl, targetUserId, el) {
            cancelEditMode(); // Скидаємо режим редагування при зміні чату
            
            document.querySelectorAll('.ch-item').forEach(i => i.classList.remove('active'));
            if(el) {
                el.classList.add('active');
                el.querySelector('.ch-preview').classList.remove("new-msg");
            }

            document.getElementById('chatMainArea').classList.add('active'); 
            if(window.innerWidth <= 768) document.getElementById('backBtn').style.display = 'block';

            document.getElementById('chatPlaceholder').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('inputArea').classList.remove('hidden');
            messagesArea.classList.remove('hidden');

            document.getElementById('headerName').innerText = name;
            document.getElementById('headerAvatar').src = avatarUrl;
            
            const headerLink = document.getElementById('headerLink');
            if (targetUserId && targetUserId !== "null") {
                headerLink.href = `/profile?userId=${targetUserId}`;
                headerLink.style.pointerEvents = "auto";
            } else {
                headerLink.href = "#";
                headerLink.style.pointerEvents = "none";
            }

            messagesArea.innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">Loading...</div>';

            try {
                if (currentChatId) await chatConnection.invoke("LeaveChat", currentChatId);
                currentChatId = chatId;
                await chatConnection.invoke("JoinChat", chatId);
            } catch(e) { console.error(e); }

            try {
                const res = await fetch(`/Chat/GetHistory?chatId=${chatId}`);
                const msgs = await res.json();
                messagesArea.innerHTML = '';
                if(msgs.length === 0) messagesArea.innerHTML = '<div style="text-align:center; padding:40px; color:#eee;">No messages. Say hi! 👋</div>';
                else msgs.forEach(m => appendMessage(m));
                scrollToBottom();
                if(window.innerWidth > 768) msgInput.focus();
            } catch (e) { messagesArea.innerHTML = '<div style="color:red;text-align:center">Error</div>'; }
        }

        // --- SEND / EDIT MESSAGE ---
        async function sendMessage() {
            const text = msgInput.value.trim();
            if (!text || !currentChatId) return;

            try {
                if (editingMessageId) {
                    // РЕЖИМ РЕДАГУВАННЯ
                    await chatConnection.invoke("EditMessage", editingMessageId, text);
                    cancelEditMode();
                } else {
                    // РЕЖИМ ВІДПРАВКИ
                    await chatConnection.invoke("SendMessage", currentChatId, text);
                }
                msgInput.value = '';
                msgInput.focus();
            } catch (e) { alert("Error"); }
        }

        // --- EDIT ACTIONS ---
        function enableEditMode(msgId) {
            // Знаходимо div з текстом
            const contentDiv = document.getElementById(`content-${msgId}`);
            if (!contentDiv) return;

            // Беремо актуальний текст (innerText ігнорує HTML теги)
            const currentText = contentDiv.innerText;

            editingMessageId = msgId;
            msgInput.value = currentText; // Вставляємо в інпут
            msgInput.focus();

            // UI зміни
            cancelEditBtn.style.display = 'block';
            sendBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
            msgInput.placeholder = "Edit message...";
        }

        function cancelEditMode() {
            editingMessageId = null;
            msgInput.value = '';
            msgInput.placeholder = "Type a message...";
            cancelEditBtn.style.display = 'none';
            sendBtn.innerHTML = '<i class="fa-solid fa-arrow-up"></i>';
        }

        async function deleteMessage(msgId) {
            if(!confirm("Delete this message?")) return;
            try {
                // Передаємо ID повідомлення і ID чату (щоб знати кому розсилати)
                await chatConnection.invoke("DeleteMessage", msgId, currentChatId);
            } catch (e) { alert("Error deleting"); }
        }

        // --- APPEND MESSAGE ---
        function appendMessage(msg) {
            const isMe = (msg.senderId.toLowerCase() === currentUserId.toLowerCase());

            // Форматування дати: 30.11.2025 14:30
            const dateObj = new Date(msg.createdAt);
            const time = dateObj.toLocaleString('uk-UA', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            }).replace(',', ''); // Прибираємо кому між датою і часом

            const avatarUrl = msg.senderAvatarUrl || '/images/default-avatar.png';
            // Використовуємо правильний контролер User
            const profileUrl = `/User/Profile?userId=${msg.senderId}`;
            const userName = escapeHtml(msg.senderName);

            // Формуємо кнопки дій (тільки для мене)
            let actionsHtml = '';
            if (isMe) {
                // Екрануємо контент для передачі в JS функцію (щоб ' або " не зламали HTML)
                const safeContent = escapeHtml(msg.content)
                    .replace(/'/g, "&apos;")
                    .replace(/"/g, "&quot;");

                actionsHtml = `
                    <div class="ch-msg-actions">
                            <button class="ch-action-btn" onclick="enableEditMode('${msg.id}')" title="Edit">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="ch-action-btn del" onclick="deleteMessage('${msg.id}')" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            }

            const editedMark = msg.isEdited ? '<span class="ch-edited-mark" style="font-style:italic; font-size:0.7em; margin-right:5px;">edited</span>' : '';

            let html = '';
            if (isMe) {
                // === Я (Справа: Кнопки -> Текст -> Аватар) ===
                html = `
                    <div class="ch-msg-row me" id="row-${msg.id}">
                        ${actionsHtml}
                        <div class="ch-msg me">
                            <div id="content-${msg.id}">${escapeHtml(msg.content)}</div>
                            <div class="ch-msg-time" id="meta-${msg.id}">
                                ${editedMark}${time}
                            </div>
                        </div>
                        <a href="${profileUrl}" title="My Profile">
                            <img src="${avatarUrl}" class="ch-msg-avatar" alt="Me" onerror="this.src='/images/default-avatar.png'">
                        </a>
                    </div>
                `;
            } else {
                // === СПІВРОЗМОВНИК (Зліва: Аватар -> Текст) ===
                html = `
                    <div class="ch-msg-row them" id="row-${msg.id}">
                        <a href="${profileUrl}" title="${userName}">
                            <img src="${avatarUrl}" class="ch-msg-avatar" alt="${userName}" onerror="this.src='/images/default-avatar.png'">
                        </a>
                        <div class="ch-msg them">
                            <div id="content-${msg.id}">${escapeHtml(msg.content)}</div>
                            <div class="ch-msg-time" id="meta-${msg.id}">
                                ${editedMark}${time}
                            </div>
                        </div>
                    </div>
                `;
            }

            messagesArea.insertAdjacentHTML('beforeend', html);
        }

        function scrollToBottom() { messagesArea.scrollTop = messagesArea.scrollHeight; }
        function closeChatMobile() { document.getElementById('chatMainArea').classList.remove('active'); msgInput.blur(); }
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

        msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        
        // Скасування редагування по ESC
        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && editingMessageId) cancelEditMode();
        });
    </script>
}