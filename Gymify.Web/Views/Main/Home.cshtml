@model Gymify.Application.ViewModels.Home.HomeViewModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Title"];
}

<div class="text-center">

    <div class="homeTop">
        <div class="homeTitle">@Localizer["LevelText"] @Model.Level</div>

        <div class="progressBarContainer">
            <div class="progressBarFill" style="width: @Math.Round(Model.ProgressPercentage)%;"></div>
        </div>

        <div class="homeXPText">
            @Model.XpEarnedInThisLevel / @Model.XpNeededForThisLevel XP
        </div>

        <div class="homeText">@Localizer["KeepGoing"]</div>

        <div class="homeButtonContainer">
            <a class="homeButton scaleButton" href="/Workout/Create">@Localizer["CreateWorkout"]</a>
            <a class="homeButton scaleButton" href="/WorkoutsFeed">@Localizer["Workouts"]</a>
        </div>
    </div>

    <div class="homeBott">
        <h2 class="homeTitle">@Localizer["LastTrainings"]</h2>

        <div class="homeWorkouts" id="last-workouts-container">

            @if (Model.LastWorkouts.Any())
            {
                @foreach (var workout in Model.LastWorkouts)
                {
                    <a class="homeWorkout"
                       asp-controller="Workout" asp-action="Details" asp-route-workoutId="@workout.Id"
                       title="@workout.CreatedAt.ToString("g")"
                       data-workout-xp="@workout.TotalXP">

                        <div class="homeWorkoutContent">
                            <span class="homeWorkoutName">@workout.Name</span>

                            <p class="homeWorkoutDescription">
                                @workout.Description
                            </p>

                            <span class="homeWorkoutXP">+@workout.TotalXP XP</span>

                            <small class="homeWorkoutDate">
                                @workout.CreatedAt.ToString("dd MMM yyyy")
                            </small>
                        </div>
                    </a>
                }
            }
            else
            {
                <p>@Localizer["NoWorkouts"]</p>
            }
        </div>
    </div>

</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function getXPColor(xp, min, max) {
                if (max === min) return 'hsl(120, 75%, 90%)';
                const percentage = (xp - min) / (max - min);
                const hue = percentage * 120;
                return `hsl(${hue}, 75%, 90%)`;
            }

            function applyHomeHeatmap() {
                const container = document.getElementById('last-workouts-container');
                if (!container) return;
                const workouts = container.querySelectorAll('a[data-workout-xp]');
                if (workouts.length === 0) return;

                let minXP = Infinity, maxXP = -Infinity;
                workouts.forEach(w => {
                    const xp = parseInt(w.dataset.workoutXp, 10);
                    if (!isNaN(xp)) { minXP = Math.min(minXP, xp); maxXP = Math.max(maxXP, xp); }
                });
                if (minXP === Infinity) return;

                workouts.forEach(w => {
                    const xp = parseInt(w.dataset.workoutXp, 10);
                    if (!isNaN(xp)) w.style.backgroundColor = getXPColor(xp, minXP, maxXP);
                    w.style.color = '#333';
                });
            }

            applyHomeHeatmap();
        });
    </script>
}
