@model Gymify.Application.ViewModels.Home.HomeViewModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Title"];
}

<div class="dashboard-wrapper">

    <div class="dashboard-header">
        <span class="level-badge">@Localizer["LevelText"] @Model.Level</span>

        <h1 class="dashboard-title">Keep crushing it!</h1>
        <p class="dashboard-subtitle">@Localizer["KeepGoing"]</p>

        <div class="xp-progress-container">
            <div class="xp-progress-fill" style="width: @Math.Round(Model.ProgressPercentage)%;"></div>
        </div>
        <div class="xp-text">
            @Model.XpEarnedInThisLevel / @Model.XpNeededForThisLevel XP
        </div>

        <div class="dashboard-actions">
            <a href="/Workout/Create" class="gym-btn gym-btn-primary scale-btn">
                @Localizer["CreateWorkout"]
            </a>
            <a href="/WorkoutsFeed" class="gym-btn gym-btn-secondary scale-btn">
                @Localizer["Workouts"]
            </a>
        </div>
    </div>

    <div>
        <h2 class="dashboard-section-title">@Localizer["LastTrainings"]</h2>

        <div class="workouts-grid" id="last-workouts-container">
            @if (Model.LastWorkouts.Any())
            {
                @foreach (var workout in Model.LastWorkouts)
                {
                            <a class="workout-card"
                               asp-controller="Workout" asp-action="Details" asp-route-workoutId="@workout.Id"
                               title="@workout.CreatedAt.ToString("g")"
                               data-workout-xp="@workout.TotalXP">

                                <div class="workout-card-header">
                                    <span class="workout-name">@workout.Name</span>
                                    <span class="workout-xp">+@workout.TotalXP XP</span>
                                </div>

                                <p class="workout-desc">
                            @workout.Description
                                </p>

                                <div class="workout-date">
                            @workout.CreatedAt.ToString("dd MMM yyyy")
                                </div>
                            </a>
                }
            }
            else
            {
                    <div style="grid-column: 1 / -1; text-align: center; color: #777; padding: 40px;">
                        <p style="font-size: 18px;">@Localizer["NoWorkouts"]</p>
                        <a href="/Workout/Create" class="gym-btn gym-btn-primary" style="margin-top:10px;">Start your first!</a>
                    </div>
            }
        </div>
    </div>

</div>

@section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {

                // === HEATMAP LOGIC (RED -> GREEN) ===
                function getXPColor(xp, min, max) {
                    // Якщо всі тренування мають однаковий XP або це одне тренування -> даємо зелений
                    if (max === min) return 'hsl(120, 80%, 90%)'; 

                    // Нормалізуємо значення від 0 до 1
                    const percentage = (xp - min) / (max - min);

                    // HSL Hue: 
                    // 0 = Червоний (мало XP)
                    // 60 = Жовтий (середньо)
                    // 120 = Зелений (багато XP)
                    const hue = percentage * 120;

                    // Повертаємо пастельний колір (Lightness 90%, Saturation 80%)
                    // Щоб текст залишався читабельним
                    return `hsl(${hue}, 80%, 90%)`;
                }

                function applyHomeHeatmap() {
                    const container = document.getElementById('last-workouts-container');
                    if (!container) return;

                    const workouts = container.querySelectorAll('a[data-workout-xp]');
                    if (workouts.length === 0) return;

                    let minXP = Infinity, maxXP = -Infinity;

                    workouts.forEach(w => {
                        const xp = parseInt(w.dataset.workoutXp, 10);
                        if (!isNaN(xp)) { 
                            minXP = Math.min(minXP, xp); 
                            maxXP = Math.max(maxXP, xp); 
                        }
                    });

                    if (minXP === Infinity) return;

                    workouts.forEach(w => {
                        const xp = parseInt(w.dataset.workoutXp, 10);
                        if (!isNaN(xp)) {
                            w.style.backgroundColor = getXPColor(xp, minXP, maxXP);
                            // Оскільки фон пастельний, текст залишаємо темним
                            w.style.color = '#333';
                        }
                    });
                }

                applyHomeHeatmap();
            });
        </script>
}