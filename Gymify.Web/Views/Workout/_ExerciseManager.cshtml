@using Gymify.Application.DTOs.UserExercise
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model List<UserExerciseDto>

@{
    // Використовуємо DTO, яке повертає сервіс, а не те, яке йде на вхід (для initialJson)
    // Якщо Model залишається List<UserExerciseDto>, то:
    var workoutId = ViewData["WorkoutId"] ?? ViewBag.WorkoutId;
    var hideButtons = ViewData["HideSaveButtons"] as bool? ?? false;
    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
    var initialJson = JsonSerializer.Serialize(Model, jsonOptions);
}

<div class="ae-manager-card">

    <div class="ae-add-panel">
        <div style="flex-grow: 1; min-width: 250px; position: relative;">
            <label class="ae-label-mini">@Localizer["Label_ExerciseName"]</label>
            <input type="text" id="mgrName" class="ae-input-std" placeholder="@Localizer["Placeholder_Search"]..." autocomplete="off">
            <ul id="mgrSuggestions" class="ae-suggestions" style="display:none;"></ul>
        </div>
        
        <div class="ae-group-small">
            <label class="ae-label-mini">@Localizer["Label_Sets"]</label>
            <input type="number" id="mgrSets" class="ae-input-std" value="3">
        </div>
        <div class="ae-group-small">
            <label class="ae-label-mini">@Localizer["Label_Reps"]</label>
            <input type="number" id="mgrReps" class="ae-input-std" value="12">
        </div>
        <div class="ae-group-small">
            <label class="ae-label-mini">@Localizer["Label_Kg"]</label>
            <input type="number" id="mgrWeight" class="ae-input-std" value="0" step="0.5">
        </div>
        <div class="ae-group-small">
            <label class="ae-label-mini">@Localizer["Label_Min"]</label>
            <input type="number" id="mgrDuration" class="ae-input-std" value="0">
        </div>
        
        <div>
            <button type="button" id="mgrBtnAdd" class="gym-btn gym-btn-primary" style="height: 42px; margin-top: 19px;">
                @Localizer["Btn_Add"]
            </button>
        </div>
    </div>

    @* Змінюємо DTO в action на AddUserExerciseDto, але зберігаємо назву exercises для коректного Model Binding *@
    <form id="mgrForm" method="post" action="@Url.Action("AddExercisesBatch", "Workout")">
        <input type="hidden" name="workoutId" value="@workoutId" />

        <div id="mgrList" class="ae-list-container">
            <div id="mgrEmpty" class="ae-empty-state">
                @Localizer["Msg_NoExercises"]
            </div>
            
            @for (int i = 0; i < Model.Count; i++)
            {
                <div class="ae-item-card">
                    @* Змінюємо ім'я поля DurationMinutes *@
                    <input type="hidden" name="exercises[@i].Id" value="@Model[i].Id" class="inp-id" />
                    <input type="hidden" name="exercises[@i].Name" value="@Model[i].Name" class="inp-name" />
                    
                    <div class="ae-item-header">
                        <span class="ae-item-title">@Model[i].Name</span>
                        <button type="button" class="gym-btn gym-btn-secondary ae-btn-remove" style="padding: 4px 10px; font-size: 12px; color: #e74c3c; border-color: #fadbd8;">
                            @Localizer["Btn_Remove"]
                        </button>
                    </div>
                    
                    <div class="ae-item-grid">
                        <div>
                            <label class="ae-label-mini">@Localizer["Label_Sets"]</label>
                            <input type="number" name="exercises[@i].Sets" value="@Model[i].Sets" class="ae-input-std inp-sets" />
                        </div>
                        <div>
                            <label class="ae-label-mini">@Localizer["Label_Reps"]</label>
                            <input type="number" name="exercises[@i].Reps" value="@Model[i].Reps" class="ae-input-std inp-reps" />
                        </div>
                        <div>
                            <label class="ae-label-mini">@Localizer["Label_Kg"]</label>
                            <input type="number" name="exercises[@i].Weight" value="@Model[i].Weight" class="ae-input-std inp-weight" step="0.5" />
                        </div>
                        <div>
                            <label class="ae-label-mini">@Localizer["Label_Min"]</label>
                            <input type="number" name="exercises[@i].DurationMinutes" value="@Model[i].DurationMinutes" class="ae-input-std inp-duration" />
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (!hideButtons)
        {
            <div class="ae-flex-end" style="padding: 20px; background: #fcfcfc;">
                <span id="mgrSaveStatus" style="display:none; font-weight:bold; color: #27ae60; margin-right: 10px;">@Localizer["Msg_Saved"]</span>
                <button type="button" id="mgrBtnCancel" class="gym-btn gym-btn-secondary">@Localizer["Btn_Cancel"]</button>
                <button type="submit" id="mgrBtnSave" class="gym-btn gym-btn-primary">@Localizer["Btn_SaveChanges"]</button>
            </div>
        }
    </form>
</div>

<template id="mgrTemplate">
    <div class="ae-item-card">
        <input type="hidden" class="inp-id">
        <input type="hidden" class="inp-name">
        
        <div class="ae-item-header">
            <span class="ae-item-title card-title-text"></span>
            <button type="button" class="gym-btn gym-btn-secondary ae-btn-remove" style="padding: 4px 10px; font-size: 12px; color: #e74c3c; border-color: #fadbd8;">
                @Localizer["Btn_Remove"]
            </button>
        </div>
        
        <div class="ae-item-grid">
            <div><label class="ae-label-mini">@Localizer["Label_Sets"]</label><input type="number" class="ae-input-std inp-sets"></div>
            <div><label class="ae-label-mini">@Localizer["Label_Reps"]</label><input type="number" class="ae-input-std inp-reps"></div>
            <div><label class="ae-label-mini">@Localizer["Label_Kg"]</label><input type="number" class="ae-input-std inp-weight" step="0.5"></div>
            @* Змінюємо ім'я поля на DurationMinutes *@
            <div><label class="ae-label-mini">@Localizer["Label_Min"]</label><input type="number" class="ae-input-std inp-duration"></div>
        </div>
    </div>
</template>

<script>
    (function() {
        // --- LOCALIZATION BRIDGE ---
        const JS_RESOURCES = {
            msgSaved: '@Localizer["Msg_Saved"]',
            msgError: '@Localizer["Msg_Error"]',
            btnSaving: '@Localizer["Btn_Saving"]',
            btnSaveChanges: '@Localizer["Btn_SaveChanges"]',
            msgExerciseNameRequired: '@Localizer["Msg_ExerciseNameRequired"]', // Для мінімальної клієнтської валідації
            msgValidationFailedTitle: '@Localizer["Msg_ValidationFailedTitle"]' // Для заголовка помилок alertify
        };

        const initialData = @Html.Raw(initialJson);
        const container = document.getElementById("mgrList");
        const emptyMsg = document.getElementById("mgrEmpty");
        const template = document.getElementById("mgrTemplate");
        const form = document.getElementById("mgrForm");
        const inName = document.getElementById("mgrName");
        const suggestions = document.getElementById("mgrSuggestions");
        const btnAdd = document.getElementById("mgrBtnAdd");
        
        function restoreInitialState() {
            container.querySelectorAll(".ae-item-card").forEach(el => el.remove()); 
            initialData.forEach(item => createCardDOM(item));
            inName.value = "";
            document.getElementById("mgrSets").value = 3;
            document.getElementById("mgrReps").value = 12;
            document.getElementById("mgrWeight").value = 0;
            document.getElementById("mgrDuration").value = 0;
            reindex();
            checkEmpty();
        }

        function createCardDOM(data) {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector(".ae-item-card"); 

            // Оновлюємо, щоб використовувати durationMinutes для нових DTO
            // 'duration' – це TimeSpan з Model, 'durationMinutes' – це введення з форми
            const durationMinutes = data.durationMinutes !== undefined ? data.durationMinutes : (data.duration ? data.duration.totalMinutes : 0);

            card.querySelector(".card-title-text").textContent = data.name;
            card.querySelector(".inp-id").value = data.id;
            card.querySelector(".inp-name").value = data.name;
            card.querySelector(".inp-sets").value = data.sets;
            card.querySelector(".inp-reps").value = data.reps;
            card.querySelector(".inp-weight").value = data.weight || 0;
            card.querySelector(".inp-duration").value = durationMinutes; // Використовуємо DurationMinutes

            card.querySelector(".ae-btn-remove").addEventListener("click", removeCard);
            container.appendChild(card);
        }

        function removeCard(e) {
            e.target.closest(".ae-item-card").remove(); 
            reindex();
            checkEmpty();
        }

        function bindRemoveEvents() {
            if(container) {
                container.querySelectorAll(".ae-btn-remove").forEach(btn => {
                    btn.removeEventListener("click", removeCard);
                    btn.addEventListener("click", removeCard);
                });
            }
        }

        function reindex() {
            const cards = container.querySelectorAll(".ae-item-card"); 
            cards.forEach((card, index) => {
                setName(card, ".inp-id", `exercises[${index}].Id`);
                setName(card, ".inp-name", `exercises[${index}].Name`);
                setName(card, ".inp-sets", `exercises[${index}].Sets`);
                setName(card, ".inp-reps", `exercises[${index}].Reps`);
                setName(card, ".inp-weight", `exercises[${index}].Weight`);
                // Оновлюємо ім'я поля для Model Binding (DurationMinutes)
                setName(card, ".inp-duration", `exercises[${index}].DurationMinutes`);
            });
        }

        function setName(parent, selector, newName) {
            const el = parent.querySelector(selector);
            if (el) el.name = newName;
        }

        function checkEmpty() {
            if(!container) return;
            const hasItems = container.querySelectorAll(".ae-item-card").length > 0;
            if(emptyMsg) emptyMsg.style.display = hasItems ? "none" : "block";
        }

        // Search logic
        let timeout;
        if(inName) {
            inName.addEventListener("input", function() {
                const q = this.value.trim();
                clearTimeout(timeout);
                if (q.length < 2) { suggestions.style.display = "none"; return; }
                timeout = setTimeout(() => {
                    fetch(`/Workout/SearchExercises?query=${encodeURIComponent(q)}`)
                        .then(res => res.json())
                        .then(data => {
                            suggestions.innerHTML = "";
                            if (data.length) {
                                suggestions.style.display = "block";
                                data.forEach(name => {
                                    const li = document.createElement("li");
                                    li.textContent = name;
                                    li.onclick = () => { inName.value = name; suggestions.style.display = "none"; };
                                    suggestions.appendChild(li);
                                });
                            } else suggestions.style.display = "none";
                        }).catch(console.error);
                }, 300);
            });
            document.addEventListener("click", e => { if (e.target !== inName && suggestions) suggestions.style.display = "none"; });
        }

        // UUID
        function generateUUID() {
            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
            // Запасний варіант для старих браузерів
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ (typeof crypto !== 'undefined' ? crypto.getRandomValues(new Uint8Array(1))[0] : 0) & 15 >> c / 4).toString(16));
        }

        if(btnAdd) {
            btnAdd.addEventListener("click", () => {
                const name = inName.value.trim();
                
                // --- МІНІМАЛЬНА КЛІЄНТСЬКА ВАЛІДАЦІЯ ---
                if (!name) { 
                    if(typeof alertify !== 'undefined') {
                        alertify.error(JS_RESOURCES.msgExerciseNameRequired, 10);
                        inName.focus();
                        return; // 0 означає нескінченний таймаут
                    } else {
                        alert(JS_RESOURCES.msgExerciseNameRequired); 
                        inName.focus();
                        return;
                    }
                }

                
                
                const data = {
                    id: generateUUID(),
                    name: name,
                    sets: document.getElementById("mgrSets").value,
                    reps: document.getElementById("mgrReps").value,
                    weight: document.getElementById("mgrWeight").value,
                    // Змінюємо назву, щоб відповідати серверному DTO
                    durationMinutes: document.getElementById("mgrDuration").value
                };
                createCardDOM(data);
                inName.value = "";
                reindex();
                checkEmpty();
            });
        }

        // Cancel / Save logic (Buttons)
        const btnCancel = document.getElementById("mgrBtnCancel");
        const btnSave = document.getElementById("mgrBtnSave");
        const statusMsg = document.getElementById("mgrSaveStatus");

        if (btnCancel) btnCancel.addEventListener("click", restoreInitialState);

        if(form) {
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                if (btnSave) { 
                    btnSave.innerHTML = JS_RESOURCES.btnSaving; 
                    btnSave.disabled = true; 
                }
                if (statusMsg) statusMsg.style.display = "none";
                reindex();
                const formData = new FormData(form);
                
                fetch(form.action, { method: 'POST', body: formData })
                .then(res => { 
                    if (res.ok) return res.json(); 
                    
                    // Обробка помилок валідації з сервера
                    return res.json().then(data => {
                        throw { serverData: data, status: res.status };
                    });
                })
                .then(data => {
                    // УСПІШНЕ ЗБЕРЕЖЕННЯ
                    if (statusMsg) {
                        statusMsg.style.display = "inline-block";
                        statusMsg.style.color = "#28a745";
                        statusMsg.innerHTML = JS_RESOURCES.msgSaved;
                        setTimeout(() => { statusMsg.style.display = "none"; }, 2000);
                    }
                    document.dispatchEvent(new CustomEvent('exercises-saved'));
                })
                .catch(error => {
                    console.error("Save Error:", error);
                    
                    let displayMessage = JS_RESOURCES.msgError || "An unexpected error occurred.";
                    
                    // Якщо помилка містить деталі валідації з сервера
                    if (error.serverData && error.serverData.errors) {
                        const errors = error.serverData.errors;
                        let errorDetails = "";
                        let indexMap = {};

                        // 1. Створюємо мапу індексів та назв для зручності
                        container.querySelectorAll(".ae-item-card").forEach((card, index) => {
                            const name = card.querySelector(".inp-name").value;
                            indexMap[`exercises[${index}].`] = `**${name}**: `;
                        });

                        // 2. Об'єднуємо всі помилки
                        for (const key in errors) {
                            if (errors.hasOwnProperty(key) && errors[key].length > 0) {
                                
                                let exerciseName = "";
                                // Намагаємося знайти назву вправи за індексом у ключі
                                for (const prefix in indexMap) {
                                    if (key.startsWith(prefix)) {
                                        exerciseName = indexMap[prefix];
                                        break;
                                    }
                                }

                                const errorList = errors[key].join(", ");
                                errorDetails += `${exerciseName}${errorList}<br>`;
                            }
                        }
                        
                        if (errorDetails) {
                            displayMessage = `<strong>${JS_RESOURCES.msgValidationFailedTitle}</strong>:<br>${errorDetails}`;
                        } else if (error.serverData && error.serverData.message) {
                            displayMessage = error.serverData.message;
                        }
                    }
                    
                    // Відображення за допомогою alertify
                    if(typeof alertify !== 'undefined') {
                        alertify.error(displayMessage, 0); // 0 означає нескінченний таймаут
                    } else {
                        // Запасний варіант
                        alert(displayMessage.replace(/<[^>]*>?/gm, ''));
                    }

                    if (statusMsg) {
                        statusMsg.style.display = "inline-block";
                        statusMsg.style.color = "#dc3545";
                        statusMsg.textContent = JS_RESOURCES.msgError;
                    }
                })
                .finally(() => {
                    if (btnSave) { 
                        btnSave.innerHTML = JS_RESOURCES.btnSaveChanges; 
                        btnSave.disabled = false; 
                    }
                });
            });
        }

        // Init
        bindRemoveEvents();
        checkEmpty();

    })();
</script>