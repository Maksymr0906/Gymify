@using Gymify.Application.DTOs.UserExercise
@model List<UserExerciseDto>

@{
    ViewData["Title"] = "Add Exercises";
    var workoutId = ViewBag.WorkoutId;
    var detailsUrl = Url.Action("Details", "Workout", new { workoutId = workoutId });
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="text-center mb-4">
                <h1 class="display-6">Workout exercises</h1>
                <p class="text-muted">Add exercises to accomplish workout creation.</p>
            </div>

            <partial name="_ExerciseManager" 
                     model="Model" 
                     view-data='@new ViewDataDictionary(ViewData) { ["HideSaveButtons"] = true }' />

            <div class="mt-5 pt-3 border-top text-center">
                <button type="button" 
                        id="btnFinish" 
                        data-url="@detailsUrl"
                        class="btn btn-lg btn-success px-5 shadow-sm">
                    Finish Creation <i class="bi bi-check-lg"></i>
                </button>

                <div class="mt-3">
                    <a asp-controller="Main" asp-action="Index" class="text-muted small text-decoration-none">Cancel</a>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const btnFinish = document.getElementById("btnFinish");
                // Отримуємо форму з Partial View (вона там є, просто без кнопок)
                const form = document.getElementById("mgrForm");

                btnFinish.addEventListener("click", function() {
                    const originalText = btnFinish.innerHTML;
                    btnFinish.disabled = true;
                    btnFinish.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            // Успіх - переходимо
                            window.location.href = btnFinish.getAttribute("data-url");
                        } else {
                            alert("Error saving. Please try again.");
                            btnFinish.disabled = false;
                            btnFinish.innerHTML = originalText;
                        }
                    })
                    .catch(error => {
                        console.error("Fetch error:", error);
                        alert("Something went wrong.");
                        btnFinish.disabled = false;
                        btnFinish.innerHTML = originalText;
                    });
                });
            });
        </script>
}