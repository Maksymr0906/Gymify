@using Gymify.Application.DTOs.UserExercise
@model List<UserExerciseDto>
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = "Add Exercises";
    var workoutId = ViewBag.WorkoutId;
    var detailsUrl = Url.Action("Finish", "Workout", new { workoutId = workoutId });
}

<div class="ae-page-container">

    <div style="text-align: center; margin-bottom: 40px;">
        <h1 class="ae-page-title">@Localizer["WorkoutExercises"]</h1>
        <p class="ae-lead-text">@Localizer["AddExercisesToAccomplishWorkoutCreation"]</p>
    </div>

    <partial name="_ExerciseManager" 
             model="Model" 
             view-data='@new ViewDataDictionary(ViewData) { ["HideSaveButtons"] = true }' />

    <div style="text-align: center; margin-top: 40px;">
        
        <button type="button" 
                id="btnFinish" 
                data-url="@detailsUrl"
                class="gym-btn gym-btn-primary scale-btn"
                style="padding: 15px 50px; font-size: 18px;">
            @Localizer["FinishCreation"] <i class="bi bi-check-lg" style="margin-left: 10px;"></i>
        </button>

        <div style="margin-top: 20px;">
            <form method="post" asp-action="RemoveWorkout" asp-route-workoutId="@workoutId">
                <button type="submit" class="gym-btn gym-btn-secondary" style="border:none; color: #999; padding: 10px;">
                    @Localizer["CancelAndDeleteWorkout"]
                </button>
            </form>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const btnFinish = document.getElementById("btnFinish");
            const form = document.getElementById("mgrForm");

            if(btnFinish && form) {
                btnFinish.addEventListener("click", function() {
                    const originalText = btnFinish.innerHTML;
                    btnFinish.disabled = true;
                    btnFinish.innerHTML = 'Saving...'; 

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = btnFinish.getAttribute("data-url");
                        } else {
                            // Using alertify if available, or alert
                            if(typeof alertify !== 'undefined') alertify.error("Error saving.");
                            else alert("Error saving.");
                            
                            btnFinish.disabled = false;
                            btnFinish.innerHTML = originalText;
                        }
                    })
                    .catch(error => {
                        console.error("Fetch error:", error);
                        btnFinish.disabled = false;
                        btnFinish.innerHTML = originalText;
                    });
                });
            }
        });
    </script>
}