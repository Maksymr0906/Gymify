@using Gymify.Application.DTOs.UserExercise
@model List<UserExerciseDto>
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["PageTitle"];
    var workoutId = ViewBag.WorkoutId;
    var detailsUrl = Url.Action("Finish", "Workout", new { workoutId = workoutId });
}

<div class="ae-page-container">

    <div style="text-align: center; margin-bottom: 40px;">
        <h1 class="ae-page-title">@Localizer["Header_Title"]</h1>
        <p class="ae-lead-text">@Localizer["Header_Subtitle"]</p>
    </div>

    @* Partial View рендерить форму з ID "mgrForm" *@
    <partial name="_ExerciseManager" 
             model="Model" 
             view-data='@new ViewDataDictionary(ViewData) { ["HideSaveButtons"] = true }' />

    <div style="text-align: center; margin-top: 40px;">
        
        <button type="button" 
                id="btnFinish" 
                data-url="@detailsUrl"
                class="gym-btn gym-btn-primary scale-btn"
                style="padding: 15px 50px; font-size: 18px;">
            @Localizer["Btn_Finish"] <i class="bi bi-check-lg" style="margin-left: 10px;"></i>
        </button>

        <div style="margin-top: 20px;">
            <form method="post" asp-action="RemoveWorkout" asp-route-workoutId="@workoutId">
                <button type="submit" class="gym-btn gym-btn-secondary" style="border:none; color: #999; padding: 10px;">
                    @Localizer["Btn_Cancel"]
                </button>
            </form>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        // Localization bridge
        const JS_RESOURCES = {
            btnSaving: '@Localizer["Btn_Saving"]',
            msgError: '@Localizer["Msg_ErrorSaving"]',
            msgValidationFailedTitle: '@Localizer["Msg_ValidationFailedTitle"]' // Додано заголовок для помилок
        };

        document.addEventListener("DOMContentLoaded", () => {
            const btnFinish = document.getElementById("btnFinish");
            const form = document.getElementById("mgrForm"); 

            if(btnFinish && form) {
                btnFinish.addEventListener("click", function() {
                    const originalText = btnFinish.innerHTML;
                    btnFinish.disabled = true;
                    btnFinish.innerHTML = JS_RESOURCES.btnSaving; 

                    const formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        // Якщо успіх - просто повертаємо JSON (або true)
                        if (response.ok) return response.json();
                        
                        // Якщо помилка (400 Bad Request тощо) - парсимо JSON з помилками і кидаємо виключення
                        return response.json().then(data => {
                            throw { serverData: data, status: response.status };
                        });
                    })
                    .then(data => {
                        // УСПІХ: Перенаправляємо на сторінку Finish
                        window.location.href = btnFinish.getAttribute("data-url");
                    })
                    .catch(error => {
                        console.error("Fetch error:", error);
                        
                        let displayMessage = JS_RESOURCES.msgError;

                        // === ЛОГІКА ОБРОБКИ ПОМИЛОК (ідентична до _ExerciseManager) ===
                        if (error.serverData && error.serverData.errors) {
                            const errors = error.serverData.errors;
                            let errorDetails = "";
                            let indexMap = {};

                            // 1. Створюємо мапу: індекс масиву -> назва вправи з input
                            // Шукаємо картки всередині форми (яка рендериться через Partial)
                            form.querySelectorAll(".ae-item-card").forEach((card, index) => {
                                const nameInput = card.querySelector(".inp-name");
                                const name = nameInput ? nameInput.value : `Exercise #${index + 1}`;
                                indexMap[`exercises[${index}].`] = `**${name}**: `;
                            });

                            // 2. Формуємо HTML список помилок
                            for (const key in errors) {
                                if (errors.hasOwnProperty(key) && errors[key].length > 0) {
                                    let exerciseName = "";
                                    
                                    // Намагаємося знайти префікс (наприклад "exercises[0].") у ключі помилки
                                    for (const prefix in indexMap) {
                                        if (key.toLowerCase().startsWith(prefix.toLowerCase())) {
                                            exerciseName = indexMap[prefix];
                                            break;
                                        }
                                    }
                                    
                                    const errorList = errors[key].join(", ");
                                    errorDetails += `${exerciseName}${errorList}<br>`;
                                }
                            }
                            
                            // 3. Якщо вдалося зібрати деталі, формуємо повідомлення
                            if (errorDetails) {
                                displayMessage = `<strong>${JS_RESOURCES.msgValidationFailedTitle}</strong>:<br>${errorDetails}`;
                            } else if (error.serverData.message) {
                                displayMessage = error.serverData.message;
                            }
                        }
                        // ==============================================================

                        // Відображення через alertify
                        if(typeof alertify !== 'undefined') {
                            alertify.error(displayMessage, 0); // 0 = не зникає саме по собі, поки юзер не клікне (для довгих помилок)
                        } else {
                            alert(displayMessage.replace(/<[^>]*>?/gm, '')); // Видаляємо HTML теги для звичайного alert
                        }
                        
                        // Повертаємо кнопку в початковий стан
                        btnFinish.disabled = false;
                        btnFinish.innerHTML = originalText;
                    });
                });
            }
        });
    </script>
}