@model List<Gymify.Application.DTOs.UserExercise.UserExerciseDto>
@{
    ViewData["Title"] = "Manage Exercises";
    var workoutId = ViewBag.WorkoutId;
}

<style>
    .exercise-manager-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        color: #333;
    }

    .add-panel {
        background-color: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #666;
            text-transform: uppercase;
        }

    .input-std {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

        .input-std:focus {
            border-color: #007bff;
            outline: none;
        }

    .input-search {
        width: 300px;
    }

    .input-qty {
        width: 80px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: opacity 0.2s;
    }

        .btn:hover {
            opacity: 0.9;
        }

    .btn-primary {
        background-color: #28a745;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        font-size: 12px;
        padding: 6px 12px;
    }

    .btn-submit {
        background-color: #007bff;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        margin-top: 20px;
    }

    .exercises-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .exercise-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .card-header {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        color: #2c3e50;
    }

    .card-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .card-actions {
        margin-top: 15px;
        text-align: right;
    }

    .search-wrapper {
        position: relative;
    }

    .suggestions-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 5px 0 0 0;
        z-index: 100;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

        .suggestions-list li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

            .suggestions-list li:hover {
                background-color: #f8f9fa;
            }

    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px;
        color: #999;
        border: 2px dashed #e0e0e0;
        border-radius: 8px;
    }
</style>

<div class="exercise-manager-container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Manage Workout Exercises</h1>
    </div>

    <div class="add-panel">
        <div class="form-group search-wrapper">
            <label>Search Exercise</label>
            <input type="text" id="inputName" class="input-std input-search" placeholder="Start typing..." autocomplete="off">
            <ul id="suggestions" class="suggestions-list" style="display:none;"></ul>
        </div>

        <div class="form-group">
            <label>Sets</label>
            <input type="number" id="inputSets" class="input-std input-qty" value="3" min="1">
        </div>

        <div class="form-group">
            <label>Reps</label>
            <input type="number" id="inputReps" class="input-std input-qty" value="12" min="1">
        </div>

        <div class="form-group">
            <label>Weight (kg)</label>
            <input type="number" id="inputWeight" class="input-std input-qty" value="0" min="0" step="0.5">
        </div>

        <div class="form-group">
            <label>Time (min)</label>
            <input type="number" id="inputDuration" class="input-std input-qty" value="0" min="0">
        </div>

        <button type="button" id="btnAdd" class="btn btn-primary">Add Exercise</button>
    </div>

    <form method="post" asp-action="AddExercisesBatch" id="exercisesForm">
        <input type="hidden" name="workoutId" value="@workoutId" />

        <div id="exercisesContainer" class="exercises-grid">
            <div id="emptyState" class="empty-state">
                No exercises added yet. Use the panel above to add one.
            </div>

            @if (Model != null && Model.Any())
            {
                for (int i = 0; i < Model.Count; i++)
                {
                    <div class="exercise-card">
                        <input type="hidden" name="exercises[@i].Id" value="@Model[i].Id" class="inp-id" />
                        <input type="hidden" name="exercises[@i].Name" value="@Model[i].Name" class="inp-name" />

                        <div class="card-header">@Model[i].Name</div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Sets</label>
                                <input type="number" name="exercises[@i].Sets" value="@Model[i].Sets" class="input-std inp-sets" />
                            </div>
                            <div class="form-group">
                                <label>Reps</label>
                                <input type="number" name="exercises[@i].Reps" value="@Model[i].Reps" class="input-std inp-reps" />
                            </div>
                            <div class="form-group">
                                <label>Weight</label>
                                <input type="number" name="exercises[@i].Weight" value="@Model[i].Weight" class="input-std inp-weight" step="0.5" />
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="number" name="exercises[@i].DurationMinutes" value="@Model[i].DurationMinutes" class="input-std inp-duration" />
                            </div>
                        </div>
                        <div class="card-actions">
                            <button type="button" class="btn btn-danger btn-remove">Remove</button>
                        </div>
                    </div>
                }
            }
        </div>

        <div style="text-align: right;">
            <button type="submit" class="btn btn-submit">Save Changes</button>
        </div>
    </form>
</div>

<template id="cardTemplate">
    <div class="exercise-card">
        <input type="hidden" class="inp-id">
        <input type="hidden" class="inp-name">

        <div class="card-header"></div>

        <div class="card-body">
            <div class="form-group">
                <label>Sets</label>
                <input type="number" class="input-std inp-sets">
            </div>
            <div class="form-group">
                <label>Reps</label>
                <input type="number" class="input-std inp-reps">
            </div>
            <div class="form-group">
                <label>Weight</label>
                <input type="number" class="input-std inp-weight" step="0.5">
            </div>
            <div class="form-group">
                <label>Time</label>
                <input type="number" class="input-std inp-duration">
            </div>
        </div>
        <div class="card-actions">
            <button type="button" class="btn btn-danger btn-remove">Remove</button>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const container = document.getElementById("exercisesContainer");
            const emptyState = document.getElementById("emptyState");
            const template = document.getElementById("cardTemplate");

            const inName = document.getElementById("inputName");
            const suggestions = document.getElementById("suggestions");
            const btnAdd = document.getElementById("btnAdd");

            checkEmptyState();

            document.querySelectorAll(".btn-remove").forEach(btn => {
                btn.addEventListener("click", function() {
                    this.closest(".exercise-card").remove();
                    reindexInputs();
                    checkEmptyState();
                });
            });

            let timeout = null;
            inName.addEventListener("input", function() {
                const q = this.value.trim();
                clearTimeout(timeout);

                if (q.length < 2) {
                    suggestions.style.display = "none";
                    return;
                }

                timeout = setTimeout(() => {
                    fetch(`/Workout/SearchExercises?query=${encodeURIComponent(q)}`)
                        .then(r => r.json())
                        .then(data => {
                            suggestions.innerHTML = "";
                            if (data.length) {
                                suggestions.style.display = "block";
                                data.forEach(name => {
                                    const li = document.createElement("li");
                                    li.textContent = name;
                                    li.onclick = () => {
                                        inName.value = name;
                                        suggestions.style.display = "none";
                                    };
                                    suggestions.appendChild(li);
                                });
                            } else {
                                suggestions.style.display = "none";
                            }
                        });
                }, 300);
            });

            document.addEventListener("click", (e) => {
                if (e.target !== inName) suggestions.style.display = "none";
            });

            function generateUUID() {
                if (typeof crypto.randomUUID === 'function') {
                    return crypto.randomUUID();
                }
                return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
            }

            btnAdd.addEventListener("click", () => {
                const name = inName.value.trim();
                if (!name) return alert("Enter exercise name");

                const data = {
                    name: name,
                    sets: document.getElementById("inputSets").value,
                    reps: document.getElementById("inputReps").value,
                    weight: document.getElementById("inputWeight").value,
                    duration: document.getElementById("inputDuration").value
                };

                createCard(data);

                inName.value = "";
                document.getElementById("inputWeight").value = "0";
            });

            function createCard(data) {
                const clone = template.content.cloneNode(true);
                const card = clone.querySelector(".exercise-card");

                const newId = generateUUID();

                card.querySelector(".card-header").textContent = data.name;

                card.querySelector(".inp-id").value = newId;
                card.querySelector(".inp-name").value = data.name;
                card.querySelector(".inp-sets").value = data.sets;
                card.querySelector(".inp-reps").value = data.reps;
                card.querySelector(".inp-weight").value = data.weight;
                card.querySelector(".inp-duration").value = data.duration;

                card.querySelector(".btn-remove").addEventListener("click", function() {
                    card.remove();
                    reindexInputs();
                    checkEmptyState();
                });

                container.appendChild(card);
                reindexInputs();
                checkEmptyState();
            }

            function reindexInputs() {
                const cards = container.querySelectorAll(".exercise-card");
                cards.forEach((card, index) => {
                    setName(card, ".inp-id", `exercises[${index}].Id`);
                    setName(card, ".inp-name", `exercises[${index}].Name`);
                    setName(card, ".inp-sets", `exercises[${index}].Sets`);
                    setName(card, ".inp-reps", `exercises[${index}].Reps`);
                    setName(card, ".inp-weight", `exercises[${index}].Weight`);
                    setName(card, ".inp-duration", `exercises[${index}].DurationMinutes`);
                });
            }

            function setName(parent, selector, newName) {
                const el = parent.querySelector(selector);
                if (el) el.name = newName;
            }

            function checkEmptyState() {
                const cards = container.querySelectorAll(".exercise-card");
                if (cards.length > 0) {
                    emptyState.style.display = "none";
                } else {
                    emptyState.style.display = "block";
                }
            }
        });
    </script>
}