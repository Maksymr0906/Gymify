@using Gymify.Application.DTOs.Workout
@using Gymify.Application.ViewModels.Workout
@model WorkoutDetailsViewModel

@{
    ViewData["Title"] = Model.Name;
}

<div class="container py-4">

    <div class="mb-5 border-bottom pb-4">
        <div class="d-flex justify-content-between align-items-start">
            <div style="flex-grow: 1; margin-right: 20px;">

                <h1 id="viewName" class="display-5 fw-bold text-primary mb-2">@Model.Name</h1>
                <input id="inputName" type="text" class="form-control form-control-lg mb-2" value="@Model.Name" style="display:none;" placeholder="Workout Name" />

                <div class="text-muted mb-3 d-flex align-items-center gap-2">
                    <span>Created by <strong>@Model.AuthorName</strong> &bull; @Model.CreatedAt.ToString("MMMM dd, yyyy")</span>
                </div>

                <div class="d-flex gap-2 align-items-center mb-3">
                    <span class="badge bg-success fs-6">XP: @Model.TotalXP</span>

                    <span id="viewPrivacy" class="badge bg-secondary fs-6" style="@(Model.IsPrivate ? "" : "display:none")">
                        <i class="bi bi-lock-fill"></i> Private
                    </span>

                    <div id="inputPrivacyWrapper" class="form-check form-switch" style="display:none;">
                        <input class="form-check-input" type="checkbox" id="inputPrivacy" @(Model.IsPrivate ? "checked" : "")>
                        <label class="form-check-label small text-muted" for="inputPrivacy">Private (Visible only to me)</label>
                    </div>
                </div>
            </div>

            @if (Model.IsOwner)
            {
                    <div class="d-flex gap-2">
                        <button id="btnCancelInfo" class="btn btn-secondary btn-sm" style="display:none;">Cancel</button>
                        <button id="btnEditInfo" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-pencil"></i> Edit Info
                        </button>
                    </div>
            }
        </div>

        <div class="mt-4">
            <div id="viewDescription" class="lead" style="white-space: pre-wrap;">@Model.Description</div>
            <textarea id="inputDescription" class="form-control mb-3" rows="3" style="display:none;" placeholder="Describe your workout...">@Model.Description</textarea>
        </div>

        <div class="mt-3">
            <div id="viewConclusionWrapper" class="alert alert-light border" style="@(string.IsNullOrEmpty(Model.Conclusion) ? "display:none" : "")">
                <h6 class="fw-bold text-muted"><i class="bi bi-chat-left-quote"></i> Conclusion:</h6>
                <p id="viewConclusion" class="mb-0 fst-italic" style="white-space: pre-wrap;">@Model.Conclusion</p>
            </div>

            <div id="inputConclusionWrapper" style="display:none;">
                <label class="form-label fw-bold text-muted small">Conclusion</label>
                <textarea id="inputConclusion" class="form-control" rows="2" placeholder="How did it go?">@Model.Conclusion</textarea>
            </div>
        </div>
    </div>

    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Workout Plan</h3>
            @if (Model.IsOwner)
            {
                    <button id="btnToggleEdit" class="btn btn-warning px-4">
                        <i class="bi bi-pencil-square"></i> Edit Exercises
                    </button>
            }
        </div>

        <div id="viewModeContainer">
            <partial name="_ExerciseListReadOnly" model="Model.Exercises" />
        </div>

        <div id="editModeContainer" style="display: none;">
            @if (Model.IsOwner)
            {
                    <partial name="_ExerciseManager" 
                             model="Model.Exercises" 
                             view-data='@new ViewDataDictionary(ViewData) { ["WorkoutId"] = Model.WorkoutId }' />
            }
        </div>
    </div>

    <div class="mt-5 pt-4 border-top">
        <h3>Comments</h3>
        <p class="text-muted">Comments module placeholder...</p>
    </div>
</div>

@section Scripts {
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- 1. ЛОГІКА РЕДАГУВАННЯ ІНФО (HEADER) ---
                const btnEdit = document.getElementById("btnEditInfo");
                const btnCancel = document.getElementById("btnCancelInfo");

                // Елементи (View / Input)
                const els = {
                    name: { view: document.getElementById("viewName"), input: document.getElementById("inputName") },
                    desc: { view: document.getElementById("viewDescription"), input: document.getElementById("inputDescription") },
                    conc: { viewWrapper: document.getElementById("viewConclusionWrapper"), inputWrapper: document.getElementById("inputConclusionWrapper"), input: document.getElementById("inputConclusion") },
                    priv: { view: document.getElementById("viewPrivacy"), inputWrapper: document.getElementById("inputPrivacyWrapper"), input: document.getElementById("inputPrivacy") }
                };

                let isEditing = false;
                // Зберігаємо оригінальні значення для Cancel
                const originalValues = {
                    name: els.name.input.value,
                    desc: els.desc.input.value,
                    conc: els.conc.input.value,
                    priv: els.priv.input.checked
                };

                if (btnEdit) {
                    btnEdit.addEventListener("click", async () => {
                        if (!isEditing) {
                            // >>> ВХІД У РЕЖИМ РЕДАГУВАННЯ
                            enterEditMode();
                        } else {
                            // >>> ЗБЕРЕЖЕННЯ (SAVE)
                            await saveChanges();
                        }
                    });
                }

                if (btnCancel) {
                    btnCancel.addEventListener("click", () => {
                        // Відновлюємо старі значення
                        els.name.input.value = originalValues.name;
                        els.desc.input.value = originalValues.desc;
                        els.conc.input.value = originalValues.conc;
                        els.priv.input.checked = originalValues.priv;
                        exitEditMode();
                    });
                }

                function enterEditMode() {
                    isEditing = true;

                    // Перемикання видимості
                    toggleVisibility(true);

                    // Зміна кнопок
                    btnEdit.innerHTML = '<i class="bi bi-check-lg"></i> Save Info';
                    btnEdit.classList.replace("btn-outline-secondary", "btn-success");
                    btnCancel.style.display = "inline-block";
                }

                function exitEditMode() {
                    isEditing = false;

                    // Перемикання видимості назад
                    toggleVisibility(false);

                    // Повернення кнопок
                    btnEdit.innerHTML = '<i class="bi bi-pencil"></i> Edit Info';
                    btnEdit.classList.replace("btn-success", "btn-outline-secondary");
                    btnEdit.disabled = false;
                    btnCancel.style.display = "none";
                }

                function toggleVisibility(editMode) {
                    // Name
                    els.name.view.style.display = editMode ? "none" : "block";
                    els.name.input.style.display = editMode ? "block" : "none";

                    // Desc
                    els.desc.view.style.display = editMode ? "none" : "block";
                    els.desc.input.style.display = editMode ? "block" : "none";

                    // Conclusion (View ховаємо, якщо пусто, але в Edit завжди показуємо Input)
                    els.conc.viewWrapper.style.display = (!editMode && originalValues.conc) ? "block" : "none";
                    els.conc.inputWrapper.style.display = editMode ? "block" : "none";

                    // Privacy
                    els.priv.view.style.display = (!editMode && els.priv.input.checked) ? "inline-block" : "none";
                    els.priv.inputWrapper.style.display = editMode ? "block" : "none";
                }

                async function saveChanges() {
                    const nameVal = els.name.input.value.trim();
                    if (!nameVal) { alert("Workout name is required!"); return; }

                    // UI: Loading state
                    btnEdit.disabled = true;
                    btnEdit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

                    const payload = {
                        id: "@Model.WorkoutId",
                        name: nameVal,
                        description: els.desc.input.value,
                        conclusion: els.conc.input.value,
                        isPrivate: els.priv.input.checked
                    };

                    try {
                        const res = await fetch('/Workout/UpdateWorkoutInfo', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            // Успіх - перезавантажуємо сторінку, щоб оновити всі дані
                            window.location.reload();
                        } else {
                            const errData = await res.json();
                            alert("Error: " + (errData.message || "Update failed"));
                            btnEdit.disabled = false;
                            btnEdit.innerHTML = '<i class="bi bi-check-lg"></i> Save Info';
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Network error");
                        btnEdit.disabled = false;
                        btnEdit.innerHTML = '<i class="bi bi-check-lg"></i> Save Info';
                    }
                }


                // --- 2. ЛОГІКА ВПРАВ (EXERCISES) - Твій старий код ---
                const btnToggle = document.getElementById("btnToggleEdit");
                const viewContainer = document.getElementById("viewModeContainer");
                const editContainer = document.getElementById("editModeContainer");
                const btnCancelInternal = document.getElementById("mgrBtnCancel");
                const workoutId = "@Model.WorkoutId"; 

                if (btnToggle) {
                    btnToggle.addEventListener("click", () => {
                        viewContainer.style.display = "none";
                        editContainer.style.display = "block";
                        btnToggle.style.display = "none";
                    });
                }
                if (btnCancelInternal) {
                    btnCancelInternal.addEventListener("click", () => {
                        viewContainer.style.display = "block";
                        editContainer.style.display = "none";
                        btnToggle.style.display = "block";
                    });
                }
                document.addEventListener('exercises-saved', function () {
                    fetch(`/Workout/GetExercisesPartial?workoutId=${workoutId}`)
                        .then(r => r.text())
                        .then(html => {
                            viewContainer.innerHTML = html;
                            viewContainer.style.display = "block";
                            editContainer.style.display = "none";
                            btnToggle.style.display = "block";
                        })
                        .catch(console.error);
                });
            });
        </script>
}