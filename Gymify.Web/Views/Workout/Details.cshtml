@using Gymify.Application.ViewModels.Workout
@model WorkoutDetailsViewModel

@{
    ViewData["Title"] = Model.Name;
}

<div class="container py-4">
    <div class="mb-5 border-bottom pb-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="display-5 fw-bold">@Model.Name</h1>
                <div class="text-muted mb-3">
                    Created by <strong>@Model.AuthorName</strong> &bull; @Model.CreatedAt.ToString("MMMM dd, yyyy")
                </div>
                <div class="d-flex gap-2">
                    <span class="badge bg-success fs-6">XP: @Model.TotalXP</span>
                    @if (Model.IsPrivate)
                    {
                            <span class="badge bg-secondary fs-6"><i class="bi bi-lock"></i> Private</span>
                    }
                </div>
            </div>

            @if (Model.IsOwner)
            {
                    <button class="btn btn-outline-secondary btn-sm">Edit Info</button>
            }
        </div>
        <p class="lead mt-4">@Model.Description</p>
    </div>

    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Workout Plan</h3>

            @if (Model.IsOwner)
            {
                    <button id="btnToggleEdit" class="btn btn-warning px-4">
                        <i class="bi bi-pencil-square"></i> Edit Exercises
                    </button>
            }
        </div>

        <div id="viewModeContainer">
            <partial name="_ExerciseListReadOnly" model="Model.Exercises" />
        </div>

        <div id="editModeContainer" style="display: none;">
            @if (Model.IsOwner)
            {
                    <partial name="_ExerciseManager" 
                             model="Model.Exercises" 
                             view-data='@new ViewDataDictionary(ViewData) { ["WorkoutId"] = Model.WorkoutId }' />
            }
        </div>
    </div>

    <div class="mt-5 pt-4 border-top">
        <h3>Comments</h3>
        <p class="text-muted">Comments module placeholder...</p>
    </div>
</div>

@section Scripts {
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const btnToggle = document.getElementById("btnToggleEdit");
                const viewContainer = document.getElementById("viewModeContainer");
                const editContainer = document.getElementById("editModeContainer");

                // Кнопка Cancel знаходиться всередині Partial View _ExerciseManager
                const btnCancelInternal = document.getElementById("mgrBtnCancel");

                // Зберігаємо ID воркаута для AJAX запиту
                const workoutId = "@Model.WorkoutId"; 

                // Перемикання режимів (Toggle / Cancel)
                if (btnToggle) {
                    btnToggle.addEventListener("click", () => {
                        viewContainer.style.display = "none";
                        editContainer.style.display = "block";
                        btnToggle.style.display = "none";
                    });
                }

                if (btnCancelInternal) {
                    btnCancelInternal.addEventListener("click", () => {
                        viewContainer.style.display = "block";
                        editContainer.style.display = "none";
                        btnToggle.style.display = "block";
                    });
                }

                // ❗ ЛОГІКА ОНОВЛЕННЯ ЧЕРЕЗ AJAX (слухаємо подію з модуля) ❗
                document.addEventListener('exercises-saved', function () {

                    // 1. Робимо запит на сервер за свіжим HTML списком
                    fetch(`/Workout/GetExercisesPartial?workoutId=${workoutId}`)
                        .then(response => response.text()) // Отримуємо HTML як текст
                        .then(html => {
                            // 2. Вставляємо отриманий HTML в контейнер перегляду
                            viewContainer.innerHTML = html;

                            // 3. Перемикаємо видимість назад на перегляд
                            viewContainer.style.display = "block";
                            editContainer.style.display = "none";
                            btnToggle.style.display = "block";
                        })
                        .catch(error => console.error('Error updating view:', error));
                });
            });
        </script>
}