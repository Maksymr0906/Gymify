@model List<Gymify.Application.DTOs.WorkoutsCalendar.WorkoutDayDto>

@{
    ViewData["Title"] = "Calendar";
}

<style>
    .day-header {
        background: #f0f0f0;
        padding: 10px 15px;
        font-weight: bold;
        cursor: pointer;
        border-top: 1px solid #ddd;
    }
    .day-header:hover {
        background: #e0e0e0;
    }
    .workout-list {
        display: none; /* Сховано за замовчуванням */
        padding: 15px;
        border-bottom: 1px solid #ddd;
    }
    .workout-list a {
        display: block;
        padding: 8px 0;
        text-decoration: none;
    }
    #load-more-btn {
        margin-top: 20px;
        width: 100%;
        padding: 10px;
    }
</style>

<h2>Моя стрічка активності</h2>

<div id="workout-feed-container">

    @await Html.PartialAsync("WorkoutsList", Model)

</div>

<button id="load-more-btn" data-page="1">
    Завантажити ще
</button>

@section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var feedContainer = document.getElementById('workout-feed-container');
                var loadMoreBtn = document.getElementById('load-more-btn');

                // 1. Відкриття/закриття списку тренувань по дню (toggle)
                feedContainer.addEventListener('click', function (event) {
                    // Перевіряємо, чи клік був по елементу з класом 'day-header'
                    if (event.target.classList.contains('day-header') || event.target.closest('.day-header')) {
                        var header = event.target.classList.contains('day-header')
                            ? event.target
                            : event.target.closest('.day-header');

                        var workoutList = header.nextElementSibling;
                        if (!workoutList) return;

                        if (workoutList.style.display === 'block') {
                            // приховати з анімацією
                            slideUp(workoutList, 300);
                        } else {
                            // показати з анімацією
                            slideDown(workoutList, 300);
                        }
                    }
                });

                // 2. Логіка "Завантажити ще"
                loadMoreBtn.addEventListener('click', function () {
                    var button = this;
                    var nextPage = parseInt(button.getAttribute('data-page'), 10);

                    button.disabled = true;
                    button.textContent = 'Завантаження...';

                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', '@Url.Action("LoadMoreWorkouts")?page=' + nextPage, true);
                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            var responseHtml = xhr.responseText.trim();

                            if (responseHtml.length > 0) {
                                // Створюємо тимчасовий контейнер для вставки HTML
                                var tempDiv = document.createElement('div');
                                tempDiv.innerHTML = responseHtml;

                                // Додаємо всі дочірні елементи у feedContainer
                                while (tempDiv.firstChild) {
                                    feedContainer.appendChild(tempDiv.firstChild);
                                }

                                button.setAttribute('data-page', nextPage + 1);
                                button.disabled = false;
                                button.textContent = 'Завантажити ще';
                            } else {
                                button.disabled = true;
                                button.textContent = 'Більше тренувань немає';
                                button.style.display = 'none';
                            }
                        } else {
                            alert('Сталася помилка. Спробуйте пізніше.');
                            button.disabled = false;
                            button.textContent = 'Завантажити ще';
                        }
                    };
                    xhr.onerror = function () {
                        alert('Сталася помилка. Спробуйте пізніше.');
                        button.disabled = false;
                        button.textContent = 'Завантажити ще';
                    };
                    xhr.send();
                });

                // Функції плавного показу/приховування (slideDown/slideUp)
                function slideUp(element, duration) {
                    element.style.height = element.offsetHeight + 'px';
                    element.style.transitionProperty = 'height, margin, padding';
                    element.style.transitionDuration = duration + 'ms';
                    element.style.boxSizing = 'border-box';
                    element.offsetHeight; // ребот на repaint

                    element.style.overflow = 'hidden';
                    element.style.height = 0;
                    element.style.paddingTop = 0;
                    element.style.paddingBottom = 0;
                    element.style.marginTop = 0;
                    element.style.marginBottom = 0;

                    window.setTimeout(function () {
                        element.style.display = 'none';
                        element.style.removeProperty('height');
                        element.style.removeProperty('padding-top');
                        element.style.removeProperty('padding-bottom');
                        element.style.removeProperty('margin-top');
                        element.style.removeProperty('margin-bottom');
                        element.style.removeProperty('overflow');
                        element.style.removeProperty('transition-duration');
                        element.style.removeProperty('transition-property');
                    }, duration);
                }

                function slideDown(element, duration) {
                    element.style.removeProperty('display');
                    let display = window.getComputedStyle(element).display;

                    if (display === 'none') {
                        display = 'block';
                    }
                    element.style.display = display;

                    let height = element.offsetHeight;
                    element.style.height = 0;
                    element.style.paddingTop = 0;
                    element.style.paddingBottom = 0;
                    element.style.marginTop = 0;
                    element.style.marginBottom = 0;
                    element.style.overflow = 'hidden';

                    element.offsetHeight; // repaint

                    element.style.transitionProperty = 'height, margin, padding';
                    element.style.transitionDuration = duration + 'ms';
                    element.style.height = height + 'px';
                    element.style.removeProperty('padding-top');
                    element.style.removeProperty('padding-bottom');
                    element.style.removeProperty('margin-top');
                    element.style.removeProperty('margin-bottom');

                    window.setTimeout(function () {
                        element.style.removeProperty('height');
                        element.style.removeProperty('overflow');
                        element.style.removeProperty('transition-duration');
                        element.style.removeProperty('transition-property');
                    }, duration);
                }
            });
        </script>
}
