@model List<Gymify.Application.DTOs.WorkoutsCalendar.WorkoutDayDto>

@{
    ViewData["Title"] = "Calendar";
    bool onlyMy = ViewBag.OnlyMy ?? true;
    string? authorName = ViewBag.AuthorName as string ?? string.Empty;
}

<h2>Моя стрічка активності</h2>

<form method="get" asp-controller="WorkoutsCalendar" asp-action="Index" class="search-form" style="margin-bottom:20px;">
    <input type="text" name="authorName" placeholder="Пошук по імені автора" value="@authorName" />

    <label style="margin-left:15px;">
        <input type="checkbox" name="onlyMy" value="true" @(onlyMy ? "checked" : "") />

        <input type="hidden" name="onlyMy" value="false" />

        Тільки мої тренування
    </label>

    <button type="submit" style="margin-left:15px;">Пошук</button>
</form>

<div id="workout-feed-container">

    @await Html.PartialAsync("WorkoutsList", Model)

</div>

<button id="load-more-btn" data-page="1">
    Завантажити ще
</button>

@section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var feedContainer = document.getElementById('workout-feed-container');
                var loadMoreBtn = document.getElementById('load-more-btn');

                // 1. Відкриття/закриття списку тренувань по дню (toggle)
                feedContainer.addEventListener('click', function (event) {
                    // Перевіряємо, чи клік був по елементу з класом 'day-header'
                    if (event.target.classList.contains('day-header') || event.target.closest('.day-header')) {
                        var header = event.target.classList.contains('day-header')
                            ? event.target
                            : event.target.closest('.day-header');

                        var workoutList = header.nextElementSibling;
                        if (!workoutList) return;

                        if (workoutList.style.display === 'block') {
                            // приховати з анімацією
                            slideUp(workoutList, 300);
                        } else {
                            // показати з анімацією
                            slideDown(workoutList, 300);
                        }
                    }
                });

                // 2. Логіка "Завантажити ще" (з виправленням)
                loadMoreBtn.addEventListener('click', function () {
                    var button = this;
                    var nextPage = parseInt(button.getAttribute('data-page'), 10);

                    // --- ПОЧАТОК ВИПРАВЛЕННЯ ---

                    // 2.1. Отримуємо поточні значення фільтрів з форми
                    var authorNameInput = document.querySelector('input[name="authorName"]');
                    var onlyMyCheckbox = document.querySelector('input[type="checkbox"][name="onlyMy"]');

                    var authorNameValue = authorNameInput ? authorNameInput.value : '';
                    var onlyMyValue = onlyMyCheckbox ? onlyMyCheckbox.checked : false; 

                    // 2.2. Будуємо URL з усіма параметрами
                    var params = new URLSearchParams();
                    params.append('page', nextPage);
                    params.append('authorName', authorNameValue);
                    params.append('onlyMy', onlyMyValue); // Додасть 'onlyMy=true' або 'onlyMy=false'

                    var url = '@Url.Action("LoadMoreWorkouts")?' + params.toString();

                    // --- КІНЕЦЬ ВИПРАВЛЕННЯ ---

                    button.disabled = true;
                    button.textContent = 'Завантаження...';

                    var xhr = new XMLHttpRequest();

                    // 2.3. Використовуємо нову URL
                    xhr.open('GET', url, true); 

                    xhr.onload = function () {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            var responseHtml = xhr.responseText.trim();

                            if (responseHtml.length > 0) {
                                var tempDiv = document.createElement('div');
                                tempDiv.innerHTML = responseHtml;

                                while (tempDiv.firstChild) {
                                    feedContainer.appendChild(tempDiv.firstChild);
                                }

                                button.setAttribute('data-page', nextPage + 1);
                                button.disabled = false;
                                button.textContent = 'Завантажити ще';
                            } else {
                                button.disabled = true;
                                button.textContent = 'Більше тренувань немає';
                                button.style.display = 'none';
                            }
                        } else {
                            alert('Сталася помилка. Спробуйте пізніше.');
                            button.disabled = false;
                            button.textContent = 'Завантажити ще';
                        }
                    };
                    xhr.onerror = function () {
                        alert('Сталася помилка. Спробуйте пізніше.');
                        button.disabled = false;
                        button.textContent = 'Завантажити ще';
                    };
                    xhr.send();
                });

                // Функції плавного показу/приховування (slideDown/slideUp)
                function slideUp(element, duration) {
                    element.style.height = element.offsetHeight + 'px';
                    element.style.transitionProperty = 'height, margin, padding';
                    element.style.transitionDuration = duration + 'ms';
                    element.style.boxSizing = 'border-box';
                    element.offsetHeight; // ребот на repaint

                    element.style.overflow = 'hidden';
                    element.style.height = 0;
                    element.style.paddingTop = 0;
                    element.style.paddingBottom = 0;
                    element.style.marginTop = 0;
                    element.style.marginBottom = 0;

                    window.setTimeout(function () {
                        element.style.display = 'none';
                        element.style.removeProperty('height');
                        element.style.removeProperty('padding-top');
                        element.style.removeProperty('padding-bottom');
                        element.style.removeProperty('margin-top');
                        element.style.removeProperty('margin-bottom');
                        element.style.removeProperty('overflow');
                        element.style.removeProperty('transition-duration');
                        element.style.removeProperty('transition-property');
                    }, duration);
                }

                function slideDown(element, duration) {
                    element.style.removeProperty('display');
                    let display = window.getComputedStyle(element).display;

                    if (display === 'none') {
                        display = 'block';
                    }
                    element.style.display = display;

                    let height = element.offsetHeight;
                    element.style.height = 0;
                    element.style.paddingTop = 0;
                    element.style.paddingBottom = 0;
                    element.style.marginTop = 0;
                    element.style.marginBottom = 0;
                    element.style.overflow = 'hidden';

                    element.offsetHeight; // repaint

                    element.style.transitionProperty = 'height, margin, padding';
                    element.style.transitionDuration = duration + 'ms';
                    element.style.height = height + 'px';
                    element.style.removeProperty('padding-top');
                    element.style.removeProperty('padding-bottom');
                    element.style.removeProperty('margin-top');
                    element.style.removeProperty('margin-bottom');

                    window.setTimeout(function () {
                        element.style.removeProperty('height');
                        element.style.removeProperty('overflow');
                        element.style.removeProperty('transition-duration');
                        element.style.removeProperty('transition-property');
                    }, duration);
                }
            });
        </script>
}
