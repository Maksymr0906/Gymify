@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model Gymify.Application.DTOs.Case.CaseInfoDto

@{
    ViewData["Title"] = Localizer["Details_Title"];
}

<div class="case-opening-page">
    <div class="case-header">
        <h2 class="text-center case-title">@Model.Name</h2>
        <div class="case-image-wrapper">
            <img src="@Model.ImageUrl" alt="@Model.Name" />
        </div>
    </div>

    <div class="roulette-wrapper">
        <div class="roulette-container">
            <div id="roulette-strip">
                </div>
        </div>
        <div class="roulette-marker"></div>
    </div>

    <div class="controls-area">
        <button id="triggerOpenCaseBtn" class="gym-btn gym-btn-primary scale-btn" data-case-id="@Model.Id">
            @Localizer["OpenCaseButton"]
        </button>
    </div>
</div>

<div id="resultModal" class="gym-modal-overlay hidden" aria-hidden="true">
    <div class="gym-modal-content">
        <div class="gym-modal-header">
            <h2 class="gym-modal-title">@Localizer["RewardTitle"]</h2>
        </div>

        <div class="gym-modal-body">
            <div class="gym-modal-image-wrapper">
                <img id="dropImage" src="" alt="Reward" />
            </div>
            <h3 id="dropName" class="gym-drop-name">Item Name</h3>
            <span id="dropRarity" class="rarity-badge">Common</span>
        </div>

        <div class="gym-modal-footer">
            <button id="resetRouletteBtn" class="gym-btn gym-btn-primary">
                @Localizer["OpenAgainButton"]
            </button>
            <a id="closeResultModal" href="~/Inventory/" class="gym-btn gym-btn-secondary">
                @Localizer["OkButton"]
            </a>
        </div>
    </div>
</div>

@section Scripts {
        <script>
            const openButton = document.getElementById("triggerOpenCaseBtn");
            const strip = document.getElementById("roulette-strip");
            const resultModal = document.getElementById("resultModal");
            const resetBtn = document.getElementById("resetRouletteBtn");

            // === OPEN CASE LOGIC ===
            openButton.addEventListener("click", async (e) => {
                e.preventDefault();

                openButton.disabled = true;
                openButton.style.opacity = "0.7";
                openButton.innerText = "Opening...";

                const caseId = e.target.dataset.caseId;

                try {
                    const response = await fetch(`/Case/OpenCase?caseId=${caseId}`, {
                        method: "POST",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    if (!response.ok) throw new Error("Server error");

                    const data = await response.json();

                    // Setup Strip
                    strip.innerHTML = '';
                    strip.style.transition = 'none';
                    strip.style.transform = 'translateX(0px)';

                    data.rouletteStrip.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `roulette-item rarity-border-${item.rarity}`;
                        div.innerHTML = `<img src="${item.imageURL}" alt="${item.name}" /><p>${item.name}</p>`;
                        strip.appendChild(div);
                    });

                    // Animation Calc
                    const itemWidth = 120; 
                    const itemMargin = 12; 
                    const totalItemWidth = itemWidth + itemMargin;
                    const containerWidth = 800; 
                    const winningIndex = 78; 

                    const winnerCenter = (winningIndex * totalItemWidth) + (totalItemWidth / 2);
                    const targetOffset = winnerCenter - (containerWidth / 2);
                    const randomJitter = Math.floor(Math.random() * 30) - 15;
                    const finalOffset = targetOffset + randomJitter;

                    // Start
                    setTimeout(() => {
                        strip.style.transition = 'transform 4s cubic-bezier(0.15, 1, 0.3, 1)'; 
                        strip.style.transform = `translateX(-${finalOffset}px)`;
                    }, 50);

                    // Result
                    setTimeout(() => {
                        document.getElementById("dropImage").src = data.imageURL;
                        document.getElementById("dropName").textContent = data.name;

                        const rBadge = document.getElementById("dropRarity");
                        rBadge.textContent = data.rarityName;
                        rBadge.className = 'rarity-badge'; 
                        rBadge.classList.add(`rarity-${data.rarityName.toLowerCase()}`);

                        resultModal.classList.remove("hidden");
                    }, 4200);

                } catch (err) {
                    console.error(err);
                    alert("Error opening case.");
                    openButton.disabled = false;
                    openButton.innerText = "Open Case";
                }
            });

            // === RESET LOGIC ===
            resetBtn.addEventListener('click', () => {
                resultModal.classList.add("hidden");
                openButton.disabled = false;
                openButton.style.opacity = "1";
                openButton.innerText = "Open Case";
                strip.style.transition = 'none';
                strip.style.transform = 'translateX(0px)';
                strip.innerHTML = ''; 
            });
        </script>
}

