@model Gymify.Application.ViewModels.Case.CaseViewModel

@{
    ViewData["Title"] = "Details";
}

<h2 class="text-center">@Model.CaseInfo.CaseName</h2>

<div class="text-center">
    <button id="openCaseBtn" class="btn btn-primary"
            data-case-id="@Model.CaseInfo.CaseId">
        Відкрити кейс
    </button>
</div>

<div class="roulette-container">
    <div id="roulette-strip"></div>
</div>

<div id="resultModal" class="modal hidden">
    <div class="modal-content">
        <h2>Твій дроп!</h2>
        <img id="dropImage" src="" width="150" />
        <h3 id="dropName"></h3>
        <p id="dropRarity"></p>
        <button id="closeModal">Закрити</button>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById("openCaseBtn").addEventListener("click", async (e) => {
            e.preventDefault();

            const caseId = e.target.dataset.caseId;

            const response = await fetch(`/Case/OpenCase?caseId=${caseId}`, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (!response.ok) {
                alert("Помилка при відкритті кейсу!");
                return;
            }

            const data = await response.json();
            const strip = document.getElementById("roulette-strip");
            strip.innerHTML = '';

            // додаємо айтеми у рулетку
            data.rewards.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('item');
                div.innerHTML = `<img src="${item.imageURL}" width="100" height="100" /><p>${item.name}</p>`;
                strip.appendChild(div);
            });

            // анімація рулетки
            const itemWidth = 130;
            const offset = data.selectedIndex * itemWidth - 400; // центрування виграшу
            strip.style.transition = 'transform 4s cubic-bezier(0.25,1,0.5,1)';
            strip.style.transform = `translateX(-${offset}px)`;

            setTimeout(() => {
                document.getElementById("dropImage").src = data.itemImageURL;
                document.getElementById("dropName").textContent = data.itemName;
                document.getElementById("dropRarity").textContent = data.itemRarity;
                document.getElementById("resultModal").classList.remove("hidden");
            }, 4200);
        });

        document.getElementById("closeModal").addEventListener("click", () => {
            document.getElementById("resultModal").classList.add("hidden");
        });
    </script>
}
