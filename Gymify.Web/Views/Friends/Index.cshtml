@using Gymify.Application.ViewModels.Friends
@using Gymify.Data.Enums
@model FriendsViewModel

@{
    ViewData["Title"] = "My Friends";
}

<style>
    /* --- LAYOUT --- */
    .ae-friends-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        flex-wrap: wrap;
        gap: 20px;
    }

    /* --- TABS --- */
    .ae-tabs-container {
        display: flex;
        gap: 25px;
    }
    
    .ae-tab-btn {
        background: none;
        border: none;
        font-weight: 600;
        color: #7f8c8d;
        font-size: 1rem;
        padding: 10px 0;
        cursor: pointer;
        position: relative;
        transition: color 0.2s;
    }
    
    .ae-tab-btn:hover { color: #3498db; }
    
    .ae-tab-btn.active {
        color: #3498db;
    }
    
    .ae-tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -11px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: #3498db;
        border-radius: 3px 3px 0 0;
    }

    /* --- SEARCH --- */
    .ae-search-inline {
        position: relative;
        min-width: 280px;
    }
    
    .ae-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #95a5a6;
        font-size: 0.9rem;
        pointer-events: none;
    }
    
    .ae-search-input {
        width: 100%;
        padding: 10px 10px 10px 38px;
        border: 1px solid #e0e0e0;
        border-radius: 20px;
        background-color: #f9f9f9;
        font-size: 0.9rem;
        outline: none;
        transition: all 0.2s;
        box-sizing: border-box;
    }
    
    .ae-search-input:focus {
        background-color: #fff;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* --- REQUEST LISTS --- */
    .ae-request-group-title {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #95a5a6;
        margin-bottom: 15px;
        margin-top: 10px;
        letter-spacing: 0.5px;
    }

    .ae-request-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: white;
        border: 1px solid #f0f0f0;
        border-radius: 10px;
        margin-bottom: 10px;
        transition: transform 0.1s, border-color 0.1s;
    }
    .ae-request-row:hover { border-color: #ddd; }

    /* --- UTILS --- */
    .ae-avatar-circle {
        width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;
    }
    .ae-user-info { display: flex; align-items: center; gap: 15px; }
    .ae-username { font-weight: 700; color: #2c3e50; font-size: 1rem; }
    .ae-meta { font-size: 0.8rem; color: #7f8c8d; }

    .hidden { display: none !important; }
    .ae-fade-in { animation: fadeIn 0.3s ease; }
    
    /* Анімація для нового елемента в списку */
    .ae-slide-in { animation: slideIn 0.4s ease-out; }

    @Html.Raw("@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }")
    @Html.Raw("@keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }")
</style>

<div class="ae-page-container">
    
    <div style="text-align: center; margin-bottom: 20px;">
        <h1 class="ae-page-title">Community</h1>
    </div>

    <div class="ae-friends-header">
        
        <div class="ae-tabs-container">
            <button class="ae-tab-btn active" onclick="switchTab('friends')" id="btn-friends">
                My Friends 
                <span class="ae-text-muted" style="font-size:0.8em; font-weight:normal;">(@Model.Friends.Count)</span>
            </button>
            
            <button class="ae-tab-btn" onclick="switchTab('requests')" id="btn-requests">
                Requests
                @if(Model.IncomingRequests.Any()) 
                { 
                    <span class="ae-badge ae-badge-xp" style="margin-left:5px; font-size:0.7em;">@Model.IncomingRequests.Count</span> 
                }
            </button>

            <button class="ae-tab-btn hidden" id="btn-search" onclick="switchTab('search')">Search Results</button>
        </div>

        <div class="ae-search-inline">
            <i class="fa-solid fa-magnifying-glass ae-search-icon"></i>
            <input type="text" id="userSearchInput" class="ae-search-input" placeholder="Find new gym partners..." autocomplete="off">
        </div>
    </div>

    <div id="tab-friends" class="ae-tab-content ae-fade-in">
        @if (!Model.Friends.Any())
        {
            <div style="text-align:center; padding:50px; color:#999; border: 2px dashed #eee; border-radius:12px;">
                <i class="fa-solid fa-user-group" style="font-size:2.5rem; margin-bottom:15px; opacity:0.3; display:block;"></i>
                <p>You have no friends yet.</p>
                <p style="font-size:0.9rem;">Use the search bar to find people!</p>
            </div>
        }
        else
        {
            <div class="ae-cards-grid">
                @foreach (var f in Model.Friends)
                {
                    <div class="ae-card-item" style="align-items: center; text-align: center;">
                        <img src="@f.AvatarUrl" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                        
                        <div class="ae-card-header-title" style="border:none; margin:0;">@f.UserName</div>
                        <div class="ae-text-muted mb-20">Level @f.Level</div>
                        
                        <a asp-controller="Chat" asp-action="Room" asp-route-chatId="@f.ChatId" class="ae-btn ae-btn-primary ae-w-100">
                            <i class="bi bi-chat-dots" style="margin-right:5px;"></i> Message
                        </a>
                        <a asp-controller="User" asp-action="Profile" asp-route-userId="@f.ProfileId" class="ae-btn ae-btn-outline ae-w-100 ae-mt-20" style="margin-top:8px;">
                            Profile
                        </a>
                    </div>
                }
            </div>
        }
    </div>

    <div id="tab-requests" class="ae-tab-content hidden ae-fade-in">
        
        <div class="ae-request-group-title">
            Incoming Requests <span style="font-weight:normal;">(@Model.IncomingRequests.Count)</span>
        </div>
        
        @if (!Model.IncomingRequests.Any())
        {
            <div class="ae-text-muted ae-mb-20" style="font-style:italic; padding-left:10px;">
                No incoming requests.
            </div>
        }
        else
        {
            <div class="ae-list-vertical ae-mb-20">
                @foreach (var r in Model.IncomingRequests)
                {
                    <div class="ae-request-row">
                        <div class="ae-user-info">
                            <img src="@r.AvatarUrl" class="ae-avatar-circle">
                            <div>
                                <div class="ae-username">@r.UserName</div>
                                <div class="ae-meta">Sent @r.SentAt?.ToString("g")</div>
                            </div>
                        </div>
                        <div class="ae-flex-row ae-gap-sm">
                            <form asp-action="Accept" asp-route-senderId="@r.ProfileId"><button class="ae-btn ae-btn-success ae-btn-sm"><i class="bi bi-check-lg"></i> Accept</button></form>
                            <form asp-action="Decline" asp-route-senderId="@r.ProfileId"><button class="ae-btn ae-btn-outline ae-btn-sm">Decline</button></form>
                        </div>
                    </div>
                }
            </div>
        }

        <div class="ae-separator"></div>

        <div class="ae-request-group-title">
            Sent Requests <span style="font-weight:normal;" id="sentCount">(@Model.OutgoingRequests.Count)</span>
        </div>

        <div id="outgoingList" class="ae-list-vertical">
            @if (!Model.OutgoingRequests.Any())
            {
                <div id="noSentMsg" class="ae-text-muted" style="font-style:italic; padding-left:10px;">
                    No sent requests.
                </div>
            }
            
            @foreach (var r in Model.OutgoingRequests)
            {
                <div class="ae-request-row" id="req-@r.ProfileId" style="background-color:#fafafa;">
                    <div class="ae-user-info" style="opacity:0.7;">
                        <img src="@r.AvatarUrl" class="ae-avatar-circle">
                        <div>
                            <div class="ae-username">@r.UserName</div>
                            <div class="ae-meta">Waiting...</div>
                        </div>
                    </div>
                    <form onsubmit="cancelRequest(event, '@r.ProfileId')">
                        <button class="ae-btn ae-btn-outline ae-btn-sm" style="color:#e74c3c; border-color:#e74c3c;">Cancel</button>
                    </form>
                </div>
            }
        </div>
    </div>

    <div id="tab-search" class="ae-tab-content hidden ae-fade-in">
        <h4 class="ae-section-title ae-mb-20">Search Results</h4>
        <div id="searchResults" class="ae-cards-grid">
            </div>
    </div>

</div>

@section Scripts {
    <script>
        // --- TAB LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.ae-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');

            document.querySelectorAll('.ae-tab-btn').forEach(btn => btn.classList.remove('active'));
            
            const btn = document.getElementById('btn-' + tabName);
            if (btn) btn.classList.add('active');
            
            if (tabName !== 'search') {
                document.getElementById('userSearchInput').value = '';
                document.getElementById('btn-search').classList.add('hidden');
            }
        }

        // --- DEBOUNCE ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- SEARCH LOGIC ---
        const searchInput = document.getElementById('userSearchInput');

        const performSearch = debounce(async (query) => {
            const container = document.getElementById('searchResults');
            const searchTabBtn = document.getElementById('btn-search');

            if (!query) {
                switchTab('friends');
                searchTabBtn.classList.add('hidden');
                return;
            }

            searchTabBtn.classList.remove('hidden');
            switchTab('search');
            
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999;">Searching...</div>';

            try {
                const res = await fetch(`/Friends/Search?query=${encodeURIComponent(query)}`);
                const users = await res.json();

                container.innerHTML = '';

                if (users.length === 0) {
                    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999;">No users found.</div>';
                    return;
                }

                users.forEach(u => {
                    let actionBtn = '';
                    // 1: Friend, 2: Sent, 3: Received
                    if (u.status === 1) {
                         actionBtn = `<a href="/Chat/Room?chatId=${u.chatId}" class="ae-btn ae-btn-primary ae-w-100">Message</a>`;
                    } 
                    else if (u.status === 2) {
                         actionBtn = `<button class="ae-btn ae-btn-outline ae-w-100" disabled style="opacity:0.6; border-style:dashed;">Request Sent</button>`;
                    }
                    else if (u.status === 3) {
                         actionBtn = `<button class="ae-btn ae-btn-warning ae-w-100" onclick="switchTab('requests')">View Request</button>`;
                    }
                    else { 
                         // Передаємо ім'я та аватар для динамічного оновлення
                         actionBtn = `<button class="ae-btn ae-btn-success ae-w-100" 
                            onclick="sendRequest(this, '${u.profileId}', '${escapeHtml(u.userName)}', '${u.avatarUrl}')">
                            <i class="bi bi-person-plus"></i> Add Friend
                         </button>`;
                    }

                    const html = `
                        <div class="ae-card-item" style="align-items: center; text-align: center;">
                            <img src="${u.avatarUrl}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
                            <div class="ae-card-header-title" style="border:none; margin:0;">${escapeHtml(u.userName)}</div>
                            <div class="ae-text-muted mb-20">Level ${u.level}</div>
                            ${actionBtn}
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="color:red; text-align:center;">Error searching.</div>';
            }
        }, 500);

        searchInput.addEventListener('input', (e) => performSearch(e.target.value.trim()));

        // --- SEND REQUEST (Updated) ---
        async function sendRequest(btn, id, userName, avatarUrl) {
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "...";

            try {
                const res = await fetch(`/Friends/SendRequest?receiverId=${id}`, { method: "POST" });
                
                if(res.ok) {
                    // Оновлюємо кнопку в пошуку
                    btn.className = "ae-btn ae-btn-outline ae-w-100";
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-check"></i> Sent';
                    btn.style.borderStyle = "dashed";

                    // Динамічно додаємо в список
                    addToOutgoingList(id, userName, avatarUrl);

                } else {
                    const errText = await res.text();
                    alert("Cannot add: " + errText);
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            } catch(e) {
                alert("Network Error");
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // --- ADD TO OUTGOING LIST (Dynamic) ---
        function addToOutgoingList(id, userName, avatarUrl) {
            const countSpan = document.getElementById('sentCount');
            const list = document.getElementById('outgoingList');

            if (countSpan) {
                let count = parseInt(countSpan.innerText.replace(/\D/g, '')) || 0;
                countSpan.innerText = `(${count + 1})`;
            }

            if (!list) return;

            // Прибираємо напис "No requests"
            const emptyMsg = document.getElementById('noSentMsg');
            if(emptyMsg) emptyMsg.style.display = 'none';

            const html = `
                <div class="ae-request-row ae-slide-in" id="req-${id}" style="background-color:#fafafa;">
                    <div class="ae-user-info" style="opacity:0.7;">
                        <img src="${avatarUrl}" class="ae-avatar-circle">
                        <div>
                            <div class="ae-username">${escapeHtml(userName)}</div>
                            <div class="ae-meta">Just now</div>
                        </div>
                    </div>
                    <form onsubmit="cancelRequest(event, '${id}')">
                        <button class="ae-btn ae-btn-outline ae-btn-sm" style="color:#e74c3c; border-color:#e74c3c;">Cancel</button>
                    </form>
                </div>
            `;
            list.insertAdjacentHTML('afterbegin', html);
        }

        // --- CANCEL REQUEST ---
        async function cancelRequest(e, id) {
            e.preventDefault(); // Зупиняємо перезавантаження форми
            //if(!confirm("Cancel request?")) return;
    
            try {
                const res = await fetch(`/Friends/Cancel?receiverId=${id}`, { method: "POST" });
                if (res.ok) {
                    // 1. Видаляємо елемент з DOM
                    const row = document.getElementById(`req-${id}`);
                    if (row) row.remove();

                    // 2. Оновлюємо лічильник (мінусуємо)
                    const countSpan = document.getElementById('sentCount');
                    if (countSpan) {
                        let count = parseInt(countSpan.innerText.replace(/\D/g, '')) || 0;
                        // Не даємо піти в мінус
                        count = count > 0 ? count - 1 : 0;
                        countSpan.innerText = `(${count})`;
                    }

                    // 3. Перевірка на пустоту після видалення
                    const list = document.getElementById('outgoingList');
            
                    // Рахуємо, скільки РЕАЛЬНИХ заявок залишилось (шукаємо елементи з класом .ae-request-row)
                    const remainingRequests = list.querySelectorAll('.ae-request-row').length;

                    if (remainingRequests === 0) {
                        const emptyMsg = document.getElementById('noSentMsg');
                
                        if (emptyMsg) {
                            // Якщо елемент існує (був просто схований) - показуємо
                            emptyMsg.style.display = 'block';
                        } else {
                            // Якщо елемента немає (був видалений) - створюємо новий
                            const msgHtml = '<div id="noSentMsg" class="ae-text-muted" style="font-style:italic; padding-left:10px;">No sent requests.</div>';
                            list.innerHTML = msgHtml; // Записуємо всередину
                        }
                    }
                } else {
                    alert("Failed to cancel");
                }
            } catch(err) { console.error(err); }
        }


        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
}