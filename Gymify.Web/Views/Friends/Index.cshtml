@using Gymify.Application.ViewModels.Friends
@using Gymify.Data.Enums
@model FriendsViewModel

@{
    ViewData["Title"] = "My Friends";
}

<div class="dashboard-wrapper">
    
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 class="wd-title">Community</h1>
    </div>

    <div class="friends-header">
        <div class="friends-tabs">
            <button class="friends-tab-btn active" onclick="switchTab('friends')" id="btn-friends">
                My Friends <span style="font-weight:normal; font-size:0.9em; opacity:0.7;">(@Model.Friends.Count)</span>
            </button>
            <button class="friends-tab-btn" onclick="switchTab('requests')" id="btn-requests">
                Requests
                @if(Model.IncomingRequests.Any()) { <span class="ae-badge-xp" style="margin-left:5px; font-size:0.7em; padding: 2px 6px;">@Model.IncomingRequests.Count</span> }
            </button>
            <button class="friends-tab-btn hidden" id="btn-search" onclick="switchTab('search')">Search Results</button>
        </div>

        <div class="friends-search-wrapper">
            <i class="fa-solid fa-magnifying-glass friends-search-icon"></i>
            <input type="text" id="userSearchInput" class="friends-search-input" placeholder="Find new gym partners..." autocomplete="off">
        </div>
    </div>

    <div id="tab-friends" class="ae-tab-content fade-in">
        @if (!Model.Friends.Any())
        {
            <div class="friends-empty">
                <i class="fa-solid fa-user-group"></i>
                <p>You have no friends yet.</p>
                <p style="font-size:0.9rem;">Use the search bar to find people!</p>
            </div>
        }
        else
        {
            <div class="ae-cards-grid">
                @foreach (var f in Model.Friends)
                {
                    <div class="ae-card-item" style="align-items: center; text-align: center; padding: 30px 20px; display: flex; flex-direction: column; height: 100%;">
                        
                        <a href="@Url.Action("Profile", "User", new { userId = f.ProfileId })" style="text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center;">
                            <img src="@f.AvatarUrl" style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; transition: transform 0.2s;">
                            <div class="ae-card-header-title" style="border:none; margin:0 0 5px 0; font-size: 1.2rem;">@f.UserName</div>
                        </a>
                        
                        <div class="ae-text-muted" style="margin-bottom: 25px;">Level @f.Level</div>
                        
                        <div style="width: 100%; display: flex; flex-direction: column; gap: 12px; margin-top: auto;">
                            <a asp-controller="Chat" asp-action="Start" asp-route-userId="@f.ProfileId" 
                               class="gym-btn gym-btn-primary w-100" style="padding: 10px;">
                               <i class="fa-solid fa-comment-dots" style="margin-right: 8px;"></i> Message
                            </a>

                            <a asp-controller="User" asp-action="Profile" asp-route-userId="@f.ProfileId" class="gym-btn gym-btn-secondary w-100" style="padding: 10px;">
                                <i class="fa-solid fa-user" style="margin-right: 8px;"></i> Profile
                            </a>

                            <form asp-action="RemoveFriend" asp-route-friendId="@f.ProfileId" method="post" style="margin: 0;"
                                  onsubmit="return confirm('Are you sure you want to remove @f.UserName from friends?');">
                                <button type="submit" class="gym-btn gym-btn-danger w-100" style="padding: 10px;">
                                    <i class="fa-solid fa-user-xmark" style="margin-right: 8px;"></i> Remove
                                </button>
                            </form>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div id="tab-requests" class="ae-tab-content hidden fade-in">
        <div class="friends-section-title">Incoming Requests <span style="font-weight:normal;">(@Model.IncomingRequests.Count)</span></div>
        @if (!Model.IncomingRequests.Any())
        {
            <div class="ae-text-muted ae-mb-20" style="font-style:italic; padding-left:10px;">No incoming requests.</div>
        }
        else
        {
            <div style="margin-bottom: 30px;">
                @foreach (var r in Model.IncomingRequests)
                {
                    <div class="request-card">
                        <a href="@Url.Action("Profile", "User", new { userId = r.ProfileId })" class="request-link-wrapper">
                            <img src="@r.AvatarUrl" class="request-avatar">
                            <div>
                                <div class="request-username">@r.UserName</div>
                                <div class="request-meta">Sent @r.SentAt?.ToString("g")</div>
                            </div>
                        </a>
                        <div style="display: flex; gap: 10px;">
                            <form asp-action="Accept" asp-route-senderId="@r.ProfileId" style="margin:0;">
                                <button class="gym-btn gym-btn-primary" style="padding: 6px 15px; font-size: 13px;"><i class="fa-solid fa-check" style="margin-right: 5px;"></i> Accept</button>
                            </form>
                            <form asp-action="Decline" asp-route-senderId="@r.ProfileId" style="margin:0;">
                                <button class="gym-btn gym-btn-secondary" style="padding: 6px 15px; font-size: 13px;">Decline</button>
                            </form>
                        </div>
                    </div>
                }
            </div>
        }

        <div class="ae-separator"></div>

        <div class="friends-section-title">Sent Requests <span style="font-weight:normal;" id="sentCount">(@Model.OutgoingRequests.Count)</span></div>
        <div id="outgoingList">
            @if (!Model.OutgoingRequests.Any())
            {
                <div id="noSentMsg" class="ae-text-muted" style="font-style:italic; padding-left:10px;">No sent requests.</div>
            }
            @foreach (var r in Model.OutgoingRequests)
            {
                <div class="request-card slide-in" id="req-@r.ProfileId">
                    <a href="@Url.Action("Profile", "User", new { userId = r.ProfileId })" class="request-link-wrapper">
                        <img src="@r.AvatarUrl" class="request-avatar">
                        <div>
                            <div class="request-username">@r.UserName</div>
                            <div class="request-meta">Waiting...</div>
                        </div>
                    </a>
                    <form onsubmit="cancelRequest(event, '@r.ProfileId')" style="margin:0;">
                        <button class="gym-btn gym-btn-danger" style="padding: 6px 15px; font-size: 13px;"><i class="fa-solid fa-xmark" style="margin-right: 5px;"></i> Cancel</button>
                    </form>
                </div>
            }
        </div>
    </div>

    <div id="tab-search" class="ae-tab-content hidden fade-in">
        <h4 class="friends-section-title">Search Results</h4>
        <div id="searchResults" class="ae-cards-grid"></div>
    </div>
</div>

@section Scripts {
    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.ae-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelectorAll('.friends-tab-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById('btn-' + tabName);
            if (btn) btn.classList.add('active');
            if (tabName !== 'search') {
                document.getElementById('userSearchInput').value = '';
                const searchTabBtn = document.getElementById('btn-search');
                if(searchTabBtn) searchTabBtn.classList.add('hidden');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const searchInput = document.getElementById('userSearchInput');

        const performSearch = debounce(async (query) => {
            const container = document.getElementById('searchResults');
            const searchTabBtn = document.getElementById('btn-search');

            if (!query) {
                switchTab('friends');
                if(searchTabBtn) searchTabBtn.classList.add('hidden');
                return;
            }

            if(searchTabBtn) searchTabBtn.classList.remove('hidden');
            switchTab('search');

            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; padding: 20px;">Searching...</div>';

            try {
                const res = await fetch(`/Friends/Search?query=${encodeURIComponent(query)}`);
                const users = await res.json();

                container.innerHTML = '';

                if (users.length === 0) {
                    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; padding: 20px;">No users found.</div>';
                    return;
                }

                users.forEach(u => {
                    let actionBtn = '';
                    if (u.status === 1) {
                         actionBtn = `<a href="/Chat/Room?chatId=${u.chatId}" class="gym-btn gym-btn-primary w-100" style="padding:8px;">Message</a>`;
                    } else if (u.status === 2) {
                         actionBtn = `<button class="gym-btn gym-btn-secondary w-100" disabled style="opacity:0.6; cursor:default; padding:8px;">Request Sent</button>`;
                    } else if (u.status === 3) {
                         actionBtn = `<button class="gym-btn gym-btn-primary w-100" onclick="switchTab('requests')" style="padding:8px;">View Request</button>`;
                    } else { 
                         actionBtn = `<button class="gym-btn gym-btn-primary w-100" style="padding:8px;"
                            onclick="sendRequest(this, '${u.profileId}', '${escapeHtml(u.userName)}', '${u.avatarUrl}')">
                            <i class="fa-solid fa-user-plus"></i> Add Friend
                         </button>`;
                    }

                    // Лінк на профіль
                    const profileLink = `/User/Profile?userId=${u.profileId}`;

                    const html = `
                        <div class="ae-card-item" style="align-items: center; text-align: center; padding: 20px;">
                            <a href="${profileLink}" style="text-decoration:none; color:inherit; display:flex; flex-direction:column; align-items:center;">
                                <img src="${u.avatarUrl}" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; transition: transform 0.2s;">
                                <div class="ae-card-header-title" style="border:none; margin:0 0 5px 0;">${escapeHtml(u.userName)}</div>
                            </a>
                            <div class="ae-text-muted mb-20" style="font-size: 0.85rem;">Level ${u.level}</div>
                            ${actionBtn}
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

            } catch (e) {
                container.innerHTML = '<div style="color:red; text-align:center; padding: 20px;">Error searching.</div>';
            }
        }, 500);

        searchInput.addEventListener('input', (e) => performSearch(e.target.value.trim()));

        async function sendRequest(btn, id, userName, avatarUrl) {
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "...";
            try {
                const res = await fetch(`/Friends/SendRequest?receiverId=${id}`, { method: "POST" });
                if(res.ok) {
                    btn.className = "gym-btn gym-btn-secondary w-100";
                    btn.style.padding = "8px";
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Sent';
                    btn.style.opacity = "0.7";
                    addToOutgoingList(id, userName, avatarUrl);
                } else {
                    const errText = await res.text();
                    alert("Cannot add: " + errText);
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            } catch(e) {
                alert("Network Error");
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function addToOutgoingList(id, userName, avatarUrl) {
            const countSpan = document.getElementById('sentCount');
            if (countSpan) {
                let count = parseInt(countSpan.innerText.replace(/\D/g, '')) || 0;
                countSpan.innerText = `(${count + 1})`;
            }
            const list = document.getElementById('outgoingList');
            if (!list) return;
            const emptyMsg = document.getElementById('noSentMsg');
            if(emptyMsg) emptyMsg.style.display = 'none';

            const profileUrl = `/User/Profile?userId=${id}`;

            const html = `
                <div class="request-card slide-in" id="req-${id}">
                    <a href="${profileUrl}" class="request-link-wrapper">
                        <img src="${avatarUrl}" class="request-avatar">
                        <div>
                            <div class="request-username">${escapeHtml(userName)}</div>
                            <div class="request-meta">Just now</div>
                        </div>
                    </a>
                    <form onsubmit="cancelRequest(event, '${id}')" style="margin:0;">
                        <button class="gym-btn gym-btn-danger" style="padding: 6px 15px; font-size: 13px;"><i class="fa-solid fa-xmark" style="margin-right: 5px;"></i> Cancel</button>
                    </form>
                </div>
            `;
            list.insertAdjacentHTML('afterbegin', html);
        }

        async function cancelRequest(e, id) {
            e.preventDefault();
            if(!confirm("Cancel request?")) return;
            try {
                const res = await fetch(`/Friends/Cancel?receiverId=${id}`, { method: "POST" });
                if (res.ok) {
                    const row = document.getElementById(`req-${id}`);
                    if (row) {
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    }
                    const countSpan = document.getElementById('sentCount');
                    if (countSpan) {
                        let count = parseInt(countSpan.innerText.replace(/\D/g, '')) || 0;
                        count = count > 0 ? count - 1 : 0;
                        countSpan.innerText = `(${count})`;
                    }
                    const list = document.getElementById('outgoingList');
                    setTimeout(() => {
                        if (list.querySelectorAll('.request-card').length === 0) {
                            const emptyMsg = document.getElementById('noSentMsg');
                            if (emptyMsg) emptyMsg.style.display = 'block';
                            else list.innerHTML = '<div id="noSentMsg" class="ae-text-muted" style="font-style:italic; padding-left:10px;">No sent requests.</div>';
                        }
                    }, 350);
                } else {
                    alert("Failed to cancel");
                }
            } catch(err) { console.error(err); }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
}