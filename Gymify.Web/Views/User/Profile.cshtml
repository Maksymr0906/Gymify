@model Gymify.Application.ViewModels.UserProfile.UserProfileViewModel
@{
    ViewData["Title"] = "Profile";
}

<div id="profileRoot" class="userProfileFullPage"
     style="background-image: url('@Model.UserEquipmentDto.BackgroundUrl');"
     data-edit-type="background">

    <div class="userProfileContentWrapper">

        <div class="userProfileCustoms">
            <div class="userProfileAvatarBlock" id="avatarBlock" data-edit-type="avatar-setup">
                <img src="@Model.UserEquipmentDto.FrameUrl" class="frameImage" id="frameImage" alt="Frame" />
                <img src="@Model.UserEquipmentDto.AvatarUrl" class="avatarImage" id="avatarImage" alt="Avatar" />
            </div>

            <div class="userProfileInfoBlock">
                @if (Model.Editable == true)
                {
                    <button class="userProfileEditButton" id="editToggleBtn">Edit</button>
                }
                <div>
                    <span id="levelView" class="userProfileLevelBadge">Level @Model.Level</span>
                </div>
                <div>
                    <span id="nameView" class="userProfileNameView">@Model.UserName</span>
                    <input id="nameInput" class="userProfileNameInput" value="@Model.UserName" style="display:none;" />
                </div>
                <div>
                    <span id="titleView" class="userProfileTitleView" data-edit-type="title">@Model.Title</span>
                </div>
            </div>
        </div>

        <div class="userProfileAchivmentBlock">
            <h2 class="userProfileAchivmentTitle">Achievements</h2>
            <ul class="userProfileAchivmentsList" id="achievementsList">
                @if (Model.Achievements != null && Model.Achievements.Any())
                {
                    foreach (var a in Model.Achievements)
                    {
                        <li class="userProfileAchivmentItem" title="@a.UnlockedAt?.ToString("g")">
                            <div class="achievementContent">
                                <img src="@a.IconUrl" class="achievementIcon" />
                                <div class="achievementText">
                                    <span class="achievementName">@a.Name</span>
                                    <small class="achievementDate">@a.UnlockedAt?.ToString("g")</small>
                                </div>
                            </div>
                        </li>
                    }
                }
                else
                {
                    <p style="color:#666;">You haven't unlocked any achievements yet.</p>
                }
            </ul>
        </div>

        <div class="userProfileLastTrains">
            <h2 class="userProfileTrainsTitle">My last trainings</h2>
            <ul class="userProfileTrainsList">
                @if (Model.Workouts != null && Model.Workouts.Any())
                {
                    foreach (var workout in Model.Workouts)
                    {
                        <a asp-controller="Workout" asp-action="Details" asp-route-workoutId="@workout.Id"
                           class="userProfileTrainLink"
                           title="@workout.CreatedAt.ToString("g")">

                            <span style="font-weight:bold; font-size:16px; text-align:center;">@workout.Name</span>
                            <small style="font-size:12px; color:#888; margin-top:5px;">@workout.CreatedAt.ToString("g")</small>
                        </a>
                    }
                }
                else
                {
                    <p style="color:#666;">No workouts yet.</p>
                }
            </ul>
        </div>

        <div class="userProfileComments">
            <div class="ae-comments-section">
                <h3 class="ae-section-title ae-mb-20">Comments</h3>
                @{
                    var commentsVm = new Gymify.Application.ViewModels.Comment.CommentsSectionViewModel
                    {
                        TargetId = Model.UserProfileId,
                        TargetType = Gymify.Data.Enums.CommentTargetType.UserProfile,
                        Items = Model.Comments?.Items ?? new List<Gymify.Application.DTOs.Comment.CommentDto>(),
                        CurrentUserAvatarUrl = Model.CurrentUserAvatarUrl
                    };
                }
                <partial name="_CommentsSection" model="commentsVm" />
            </div>
        </div>

    </div>
</div>

<div id="itemPickerOverlay" aria-hidden="true" style="display:none;">
    <div id="itemPickerHeader">
        <div id="itemPickerTitle">Choose item</div>

        <div id="pickerTabs" style="display:flex; gap:10px; margin: 10px 0;"></div>

        <div id="uploadContainer" style="margin-left: auto; display:none; align-items:center; gap: 10px;">
            <input type="file" id="pickerFileUploadInput" accept=".png,.jpg,.jpeg" style="display:none;" />
            <button id="pickerUploadBtn" class="userProfileEditButton" style="font-size:14px; padding:6px 12px; background:#444;">
                + Upload
            </button>
        </div>
        <div>
            <button id="itemPickerCancel" class="userProfileEditButton" style="background:#666; margin-right:8px;">Cancel</button>
            <button id="itemPickerApply" class="userProfileEditButton" style="background:var(--ButtonColor,#2b8be6);">Apply</button>
        </div>
    </div>
    <div id="itemPickerList"></div>
</div>

<script>
    (() => {
        let isEditMode = false;

        // ID вибраних предметів
        let selectedAvatarId = null;
        let selectedFrameId = null;
        let selectedBackgroundId = null;
        let selectedTitleId = null;

        // Змінні пікера
        let pickerCurrentMode = null;
        let pickerSelectedItemId = null;
        let pickerSelectedItemUrl = null;
        let pickerSelectedItemName = null;

        let tempAvatarSelection = { id: null, url: null, name: null };
        let tempFrameSelection = { id: null, url: null, name: null };

        // Оригінали
        const original = {
            name: document.getElementById('nameView').innerText.trim(),
            titleText: document.getElementById('titleView').innerText.trim(),
            avatarUrl: document.getElementById('avatarImage').src,
            frameUrl: document.getElementById('frameImage').src,
            backgroundUrl: document.getElementById('profileRoot').style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '')
        };

        function enterEditMode() {
            if (isEditMode) return;
            isEditMode = true;
            document.getElementById('nameView').style.display = 'none';
            document.getElementById('nameInput').style.display = 'block';

            document.getElementById('titleView').style.cursor = 'pointer';
            document.getElementById('titleView').title = "Change Title";

            document.getElementById('profileRoot').style.cursor = 'pointer';
            document.getElementById('profileRoot').title = "Change Background";

            document.getElementById('avatarBlock').title = "Change Avatar or Frame";

            const btn = document.getElementById('editToggleBtn');
            if (btn) { btn.innerText = 'Save changes'; btn.style.background = '#ff9f1c'; }
        }

        function exitEditMode() {
            isEditMode = false;
            document.getElementById('nameView').style.display = 'block';
            document.getElementById('nameInput').style.display = 'none';
            document.getElementById('titleView').style.cursor = 'default';
            document.getElementById('profileRoot').style.cursor = 'default';
            document.getElementById('avatarBlock').title = "";

            const btn = document.getElementById('editToggleBtn');
            if (btn) { btn.innerText = 'Edit'; btn.style.background = ''; }

            // Закриваємо пікер, якщо він відкритий
            document.getElementById('itemPickerOverlay').style.display = 'none';
        }

        function stopPropagationHandler(e) {
            e.stopPropagation();
        }

        // Блокуємо спливання
        document.querySelector('.userProfileCustoms').addEventListener('click', stopPropagationHandler);
        document.querySelector('.userProfileAchivmentBlock').addEventListener('click', stopPropagationHandler);
        document.querySelector('.userProfileLastTrains').addEventListener('click', stopPropagationHandler);
        document.querySelector('.userProfileComments').addEventListener('click', stopPropagationHandler);

        // === ОБРОБНИК КЛІКІВ ===
        document.querySelectorAll('[data-edit-type]').forEach(el => {
            el.addEventListener('click', (ev) => {
                if (!isEditMode) return;
                ev.stopPropagation();
                const type = el.getAttribute('data-edit-type');

                if (type === 'avatar-setup') {
                    openPickerWithTabs();
                } else {
                    openPickerSimple(type);
                }
            });
        });

        document.getElementById('profileRoot').addEventListener('click', (ev) => {
            if (!isEditMode) return;
            if (ev.target !== ev.currentTarget) return;
            openPickerSimple('background');
        });

        // === ФУНКЦІЇ ВІДКРИТТЯ ПІКЕРА ===
        function openPickerSimple(type) {
            const tabsDiv = document.getElementById('pickerTabs');
            tabsDiv.innerHTML = '';
            loadItemsIntoPicker(type);
        }

        function openPickerWithTabs() {
            const tabsDiv = document.getElementById('pickerTabs');
            tabsDiv.innerHTML = '';

            const btnAvatar = document.createElement('button');
            btnAvatar.innerText = 'Avatars';
            btnAvatar.className = 'pickerTabBtn active';

            const btnFrame = document.createElement('button');
            btnFrame.innerText = 'Frames';
            btnFrame.className = 'pickerTabBtn';

            btnAvatar.onclick = () => {
                btnAvatar.classList.add('active');
                btnFrame.classList.remove('active');
                loadItemsIntoPicker('avatar');
            };

            btnFrame.onclick = () => {
                btnFrame.classList.add('active');
                btnAvatar.classList.remove('active');
                loadItemsIntoPicker('frame');
            };

            tabsDiv.appendChild(btnAvatar);
            tabsDiv.appendChild(btnFrame);

            loadItemsIntoPicker('avatar');
        }

        // === ЗАВАНТАЖЕННЯ ДАНИХ (Fetch) ===
        async function loadItemsIntoPicker(type) {
            // Збереження попереднього вибору
            if (pickerCurrentMode === 'avatar') {
                tempAvatarSelection = { id: pickerSelectedItemId, url: pickerSelectedItemUrl, name: pickerSelectedItemName };
            } else if (pickerCurrentMode === 'frame') {
                tempFrameSelection = { id: pickerSelectedItemId, url: pickerSelectedItemUrl, name: pickerSelectedItemName };
            }

            pickerCurrentMode = type;
            pickerSelectedItemId = null;

            // === ЛОГІКА ПОКАЗУ КНОПКИ ЗАВАНТАЖЕННЯ ===
            const uploadContainer = document.getElementById('uploadContainer');
            // Показуємо кнопку тільки для аватарів (можна змінити умову за потреби)
            if (type === 'avatar') {
                uploadContainer.style.display = 'flex';
            } else {
                uploadContainer.style.display = 'none';
            }

            const list = document.getElementById('itemPickerList');
            const overlay = document.getElementById('itemPickerOverlay');
            const titleLabel = document.getElementById('itemPickerTitle');

            titleLabel.innerText = 'Choose ' + type;
            list.innerHTML = '<div style="padding:20px;">Loading...</div>';
            overlay.style.display = 'block';

            try {
                const resp = await fetch(`/userEquipment?type=${encodeURIComponent(type)}`);
                const items = await resp.json();

                list.innerHTML = '';
                if (!items || items.length === 0) {
                    list.innerHTML = '<div style="color:#ccc">No items found</div>';
                    // Не робимо return, щоб користувач міг завантажити свій
                }

                // Відновлення вибору
                let activeSelection = { id: null };
                if (type === 'avatar') {
                    activeSelection = tempAvatarSelection;
                } else if (type === 'frame') {
                    activeSelection = tempFrameSelection;
                }

                if(items && items.length > 0) {
                    items.forEach(it => {
                        createPickerElement(it, activeSelection.id);
                    });
                }

            } catch (err) {
                console.error(err);
                list.innerHTML = '<div style="color:#f88">Error loading items</div>';
            }
        }

        // === СТВОРЕННЯ ЕЛЕМЕНТА ПІКЕРА ===
        function createPickerElement(item, activeId) {
            const list = document.getElementById('itemPickerList');
            let el;

            if (pickerCurrentMode === 'title') {
                el = document.createElement('div');
                el.className = 'titleItem';
                el.innerText = item.name;
            } else {
                el = document.createElement('img');
                el.className = 'pickerItem';
                el.src = item.url;
            }

            el.title = item.name || '';

            if (item.id === activeId) {
                el.classList.add('selected');
                pickerSelectedItemId = item.id;
                pickerSelectedItemUrl = item.url;
                pickerSelectedItemName = item.name;
            }

            el.addEventListener('click', () => {
                list.querySelectorAll('.selected').forEach(x => x.classList.remove('selected'));
                el.classList.add('selected');
                pickerSelectedItemId = item.id;
                pickerSelectedItemUrl = item.url;
                pickerSelectedItemName = item.name;
            });

            list.appendChild(el);
            return el;
        }

        // === UPLOAD LOGIC (ПРОВІДНИК ТА ЗАВАНТАЖЕННЯ) ===
        const fileInput = document.getElementById('pickerFileUploadInput');
        const uploadBtn = document.getElementById('pickerUploadBtn');

        if(uploadBtn && fileInput) {
            // Клік по кнопці викликає input file
            uploadBtn.addEventListener('click', () => {
                fileInput.value = '';
                fileInput.click();
            });

            // Коли файл обрано
            fileInput.addEventListener('change', async () => {
                const file = fileInput.files[0];
                if (!file) return;

                uploadBtn.innerText = 'Uploading...';
                uploadBtn.disabled = true;

                const formData = new FormData();
                formData.append("file", file);
                // formData.append("type", pickerCurrentMode); // Якщо потрібно передати тип

                try {
                    const response = await fetch('/Image/UploadFromComponent', {
                        method: "POST",
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();

                        const newItem = {
                            id: result.id,
                            url: result.url,
                            name: "Custom Avatar"
                        };

                        // Очистити повідомлення "No items" якщо є
                        const list = document.getElementById('itemPickerList');
                        if (list.innerHTML.includes('No items')) list.innerHTML = '';

                        // Додати новий елемент та вибрати його
                        const el = createPickerElement(newItem, null);
                        el.click(); // Авто-вибір
                        el.scrollIntoView({ behavior: 'smooth' });

                    } else {
                        alert("Upload failed.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("Error uploading file.");
                } finally {
                    uploadBtn.innerText = '+ Upload';
                    uploadBtn.disabled = false;
                }
            });
        }

        // === СКИДАННЯ СТАНУ ===
        function resetPickerModalState() {
            tempAvatarSelection = { id: null, url: null, name: null };
            tempFrameSelection = { id: null, url: null, name: null };
            pickerSelectedItemId = null;
            pickerSelectedItemUrl = null;
            pickerSelectedItemName = null;
            pickerCurrentMode = null;
            document.getElementById('itemPickerOverlay').style.display = 'none';
        }

        // === APPLY ===
        document.getElementById('itemPickerApply').addEventListener('click', () => {
            if (pickerCurrentMode === 'avatar') {
                tempAvatarSelection = { id: pickerSelectedItemId, url: pickerSelectedItemUrl, name: pickerSelectedItemName };
            } else if (pickerCurrentMode === 'frame') {
                tempFrameSelection = { id: pickerSelectedItemId, url: pickerSelectedItemUrl, name: pickerSelectedItemName };
            }

            if (tempAvatarSelection.id) applyPickedItem('avatar', tempAvatarSelection.id, tempAvatarSelection.url, tempAvatarSelection.name);
            if (tempFrameSelection.id) applyPickedItem('frame', tempFrameSelection.id, tempFrameSelection.url, tempFrameSelection.name);

            if (pickerCurrentMode === 'title' || pickerCurrentMode === 'background') {
                 if (pickerSelectedItemId) {
                     applyPickedItem(pickerCurrentMode, pickerSelectedItemId, pickerSelectedItemUrl, pickerSelectedItemName);
                 }
            }
            resetPickerModalState();
        });

        document.getElementById('itemPickerCancel').addEventListener('click', () => {
            resetPickerModalState();
        });

        function applyPickedItem(type, id, url, name) {
            if (type === 'avatar') {
                document.getElementById('avatarImage').src = url;
                selectedAvatarId = id;
            } else if (type === 'frame') {
                document.getElementById('frameImage').src = url;
                selectedFrameId = id;
            } else if (type === 'background') {
                document.getElementById('profileRoot').style.backgroundImage = `url('${url}')`;
                selectedBackgroundId = id;
            } else if (type === 'title') {
                document.getElementById('titleView').innerText = name;
                selectedTitleId = id;
            }
        }

        // === SAVE / CANCEL PAGE EDIT ===
        const editBtn = document.getElementById('editToggleBtn');
        if (editBtn) {
            editBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!isEditMode) { enterEditMode(); return; }

                editBtn.disabled = true;
                editBtn.innerText = 'Saving...';

                const currentName = document.getElementById('nameInput').value.trim();

                try {
                    if (currentName !== original.name) {
                        const nameData = new FormData();
                        nameData.append('updatedUserName', currentName);
                        const nameRes = await fetch('/updateUserName', { method: 'POST', body: nameData });
                        if (!nameRes.ok) throw new Error("Failed to update name");
                    }

                    const equipmentPayload = {
                        titleId: selectedTitleId,
                        avatarId: selectedAvatarId,
                        frameId: selectedFrameId,
                        backgroundId: selectedBackgroundId
                    };

                    const equipRes = await fetch('/updateProfile', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(equipmentPayload)
                    });

                    if (!equipRes.ok) throw new Error(await equipRes.text());
                    location.reload();

                } catch (err) {
                    console.error(err);
                    alert('Error: ' + err.message);
                    editBtn.disabled = false;
                    editBtn.innerText = 'Save changes';
                }
            });

            editBtn.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                if (!isEditMode) return;
                document.getElementById('nameInput').value = original.name;
                document.getElementById('titleView').innerText = original.titleText;
                document.getElementById('avatarImage').src = original.avatarUrl;
                document.getElementById('frameImage').src = original.frameUrl;
                document.getElementById('profileRoot').style.backgroundImage = `url('${original.backgroundUrl}')`;
                selectedAvatarId = null; selectedFrameId = null; selectedBackgroundId = null; selectedTitleId = null;
                exitEditMode();
            });
        }

        exitEditMode();
    })();
</script>