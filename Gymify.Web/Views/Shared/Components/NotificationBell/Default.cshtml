@using Gymify.Application.ViewModels.NotificationBell
@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization
@inject IViewLocalizer Localizer
@model NotificationBellViewModel

<div class="nt-wrapper" id="ntWrapper">

    <button class="nt-btn" id="ntBtn" onclick="toggleNtMenu()">
        <div class="nt-icon">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        </div>

        <div id="ntBadge" class="nt-badge @(Model.UnreadCount > 0 ? "" : "hidden")">
            @Model.UnreadCount
        </div>
    </button>

    <div class="nt-dropdown" id="ntMenu">
        <div class="nt-header">
            <span class="nt-title">@Localizer["Header_Notifications"]</span>
            <button class="nt-action" onclick="markAllAsRead()">@Localizer["Btn_ClearAll"]</button>
        </div>

        <div class="nt-list" id="ntList">
            @if (Model.Notifications != null && Model.Notifications.Any())
            {
                @foreach (var n in Model.Notifications)
                {
                    <a href="javascript:void(0)" 
                        class="nt-item unread" 
                        onclick="readAndRedirect(this, '@n.Id', '@n.Link')">

                        <span class="nt-msg">@n.Content</span>
                        <span class="nt-date">@n.CreatedAt.ToString("g")</span>
                    </a>
                }
            }
            else
            {
                <div class="nt-empty">@Localizer["Msg_NoNotifications"]</div>
            }
        </div>
    </div>
</div>

<script>
    // --- LOCALIZATION CONFIG ---
    const NT_CONFIG = {
        justNow: '@Localizer["Label_JustNow"]',
        // Отримуємо код мови ("uk" або "en") для вибору правильного поля з SignalR об'єкта
        langCode: '@CultureInfo.CurrentCulture.TwoLetterISOLanguageName' 
    };

    function toggleNtMenu() {
        const menu = document.getElementById('ntMenu');
        const btn = document.getElementById('ntBtn');
        menu.classList.toggle('active');
        btn.classList.toggle('active');
    }

    // Закриття при кліку зовні
    window.addEventListener('click', function(e) {
        const wrapper = document.getElementById('ntWrapper');
        if (!wrapper.contains(e.target)) {
            const menu = document.getElementById('ntMenu');
            const btn = document.getElementById('ntBtn');
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                btn.classList.remove('active');
            }
        }
    });

    function readAndRedirect(el, id, url) {
        fetch(`/Notification/Read?id=${id}`, { method: "POST" });
        el.classList.remove('unread');
        el.classList.add('read-state');
        updateBadge(-1);
        if (url && url !== '#') {
             window.location.href = url;
        }
    }

    function markAllAsRead() {
        fetch(`/Notification/ReadAll`, { method: "POST" });
        const items = document.querySelectorAll('.nt-item.unread');
        items.forEach(item => {
            item.classList.remove('unread');
            item.classList.add('read-state');
        });
        const badge = document.getElementById('ntBadge');
        badge.innerText = "0";
        badge.classList.add('hidden');
    }

    function updateBadge(change) {
        const badge = document.getElementById('ntBadge');
        let count = parseInt(badge.innerText) || 0;
        count += change;
        if (count <= 0) {
            count = 0;
            badge.classList.add('hidden');
        } else {
            badge.innerText = count;
            badge.classList.remove('hidden');
        }
    }

    // Функція, що викликається з Layout при отриманні SignalR повідомлення
    window.receiveNotificationUI = function(data) {
        const list = document.getElementById("ntList");
        const empty = list.querySelector('.nt-empty');

        // Визначаємо текст повідомлення на основі поточної культури
        let message = (NT_CONFIG.langCode === 'uk') ? data.messageUk : data.messageEn;
        
        // Фолбек: якщо потрібної мови немає, беремо будь-яку доступну
        if (!message) message = data.messageEn || data.messageUk;

        if (empty) empty.remove();

        const html = `
            <a href="javascript:void(0)"
               class="nt-item unread"
               onclick="readAndRedirect(this, '${data.id}', '${data.link}')">

                <span class="nt-msg">${message}</span>
                <span class="nt-date">${NT_CONFIG.justNow}</span>
            </a>
        `;

        list.insertAdjacentHTML('afterbegin', html);
        updateBadge(1);

        // Анімація дзвіночка
        const btn = document.getElementById('ntBtn');
        btn.style.transform = "scale(1.2) rotate(15deg)";
        setTimeout(() => btn.style.transform = "scale(1) rotate(0)", 300);
    };
</script>