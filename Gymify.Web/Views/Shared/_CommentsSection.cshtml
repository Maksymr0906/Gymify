@using Gymify.Application.ViewModels.Comment
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model CommentsSectionViewModel

<div class="co-container">

    <div class="co-form-wrapper">
        <a href="@Url.Action("Profile", "User", new { userId = Guid.Parse(User.FindFirst("UserProfileId")?.Value ?? Guid.Empty.ToString()) })">
            <img src="@Model.CurrentUserAvatarUrl" class="co-avatar" alt="@Localizer["Alt_UserAvatar"]">
        </a>
        <div class="co-input-block">
            <form id="coCommentForm">
                <input type="hidden" name="targetId" value="@Model.TargetId" />
                <input type="hidden" name="targetType" value="@Model.TargetType" />

                <textarea name="content" id="coContentInput" class="co-textarea" placeholder="@Localizer["Placeholder_WriteComment"]"></textarea>

                <div id="coAddError" class="hidden" style="color: #dc3545; font-size: 0.85rem; margin-top: 5px; font-weight: 500;"></div>

                <div style="text-align: right; margin-top: 10px;">
                    <button type="submit" id="coBtnPost" class="gym-btn gym-btn-primary" style="padding: 8px 20px; font-size: 14px;" disabled>
                        @Localizer["Btn_PostComment"]
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="coCommentsList" class="co-list">
        @if (Model.CommentDtos != null && Model.CommentDtos.Any())
        {
            @foreach (var comment in Model.CommentDtos)
            {
                <div class="co-item" id="comment-el-@comment.Id">
                    <a href="@Url.Action("Profile", "User", new { userId = comment.AuthorId })">
                        <img src="@comment.AuthorAvatarUrl" class="co-avatar" alt="@Localizer["Alt_UserAvatar"]">
                    </a>

                    <div class="co-content">
                        <div class="co-header">
                            <div>
                                <a href="@Url.Action("Profile", "User", new { userId = comment.AuthorId })" class="co-author-link">
                                    @comment.AuthorName
                                </a>
                                <span class="co-date">&bull; @comment.CreatedAt.ToString("g")</span>
                            </div>

                            @if (comment.CanDelete)
                            {
                                <div class="co-actions">
                                    <button class="co-action-btn" onclick="editCommentStart('@comment.Id')">@Localizer["Btn_Edit"]</button>
                                    <button class="co-action-btn delete" onclick="deleteCommentNode(this, '@comment.Id')">@Localizer["Btn_Delete"]</button>
                                </div>
                            }
                        </div>

                        <div class="co-text" id="text-@comment.Id">@comment.Content</div>

                        <div class="co-edit-area hidden" id="edit-area-@comment.Id">
                            <textarea class="co-edit-textarea" id="input-@comment.Id">@comment.Content</textarea>

                            <div id="edit-error-@comment.Id" class="hidden" style="color: #dc3545; font-size: 0.8rem; margin-bottom: 5px;"></div>

                            <div class="co-edit-controls">
                                <button class="gym-btn gym-btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editCommentCancel('@comment.Id')">
                                    @Localizer["Btn_Cancel"]
                                </button>
                                <button class="gym-btn gym-btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="editCommentSave('@comment.Id')">
                                    @Localizer["Btn_Save"]
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div id="coNoComments" class="co-empty-msg">@Localizer["Msg_NoComments"]</div>
        }
    </div>
</div>

<script>
    (function() {
        // --- LOCALIZATION BRIDGE ---
        const JS_RESOURCES = {
            btnPost: '@Localizer["Btn_PostComment"]',
            btnPosting: '@Localizer["Btn_Posting"]',
            btnEdit: '@Localizer["Btn_Edit"]',
            btnDelete: '@Localizer["Btn_Delete"]',
            btnCancel: '@Localizer["Btn_Cancel"]',
            btnSave: '@Localizer["Btn_Save"]',
            labelJustNow: '@Localizer["Label_JustNow"]',
            msgErrorPost: '@Localizer["Msg_ErrorPost"]',
            msgEmptyComment: '@Localizer["Msg_EmptyComment"]',
            msgErrorUpdate: '@Localizer["Msg_ErrorUpdate"]',
            msgConfirmDelete: '@Localizer["Msg_ConfirmDelete"]',
            msgErrorDelete: '@Localizer["Msg_ErrorDelete"]',
            altAvatar: '@Localizer["Alt_UserAvatar"]',
            msgCommentDeleted: '@Localizer["Msg_CommentDeleted"]' // "Comment deleted"
        };

        const form = document.getElementById('coCommentForm');
        const input = document.getElementById('coContentInput');
        const btn = document.getElementById('coBtnPost');
        const list = document.getElementById('coCommentsList');
        const emptyMsg = document.getElementById('coNoComments');
        const addErrorEl = document.getElementById('coAddError');

        if(input && btn) {
            input.addEventListener('input', () => {
                const val = input.value.trim();
                btn.disabled = val.length === 0;
                if (val.length > 0 && addErrorEl) {
                    addErrorEl.classList.add('hidden');
                    addErrorEl.innerText = "";
                }
            });
        }

        // --- POST COMMENT ---
        if(form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const originalText = JS_RESOURCES.btnPost;

                if(addErrorEl) {
                    addErrorEl.classList.add('hidden');
                    addErrorEl.innerText = "";
                }

                btn.disabled = true;
                btn.innerText = JS_RESOURCES.btnPosting;

                try {
                    const res = await fetch('/Comment/AddComment', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (res.ok) {
                        appendCommentDOM(data);
                        input.value = "";
                        btn.disabled = true;
                    } else {
                        if (data.errors && data.errors.Content) {
                            if(addErrorEl) {
                                const msg = Array.isArray(data.errors.Content) ? data.errors.Content[0] : data.errors.Content;
                                addErrorEl.innerText = msg;
                                addErrorEl.classList.remove('hidden');
                            }
                        } else {
                            if(typeof alertify !== 'undefined') alertify.error(data.message || JS_RESOURCES.msgErrorPost);
                        }
                    }
                } catch (err) {
                    console.error(err);
                    if(typeof alertify !== 'undefined') alertify.error(JS_RESOURCES.msgErrorPost);
                }
                finally {
                    btn.innerText = originalText;
                }
            });
        }

        function appendCommentDOM(c) {
            if(emptyMsg) emptyMsg.style.display = 'none';

            const domId = 'comment-el-' + (c.id || Date.now());
            const profileUrl = `/User/Profile?userId=${c.authorId}`;

            const html = `
                <div class="co-item" id="${domId}">
                    <a href="${profileUrl}"><img src="${c.authorAvatarUrl || '/images/default-avatar.png'}" class="co-avatar" alt="${JS_RESOURCES.altAvatar}"></a>
                    <div class="co-content">
                        <div class="co-header">
                            <div>
                                <a href="${profileUrl}" class="co-author-link">${escapeHtml(c.authorName)}</a>
                                <span class="co-date">&bull; ${JS_RESOURCES.labelJustNow}</span>
                            </div>
                            <div class="co-actions">
                                <button class="co-action-btn" onclick="editCommentStart('${c.id}')">${JS_RESOURCES.btnEdit}</button>
                                <button class="co-action-btn delete" onclick="deleteCommentNode(this, '${c.id}')">${JS_RESOURCES.btnDelete}</button>
                            </div>
                        </div>
                        <div class="co-text" id="text-${c.id}">${escapeHtml(c.content)}</div>

                        <div class="co-edit-area hidden" id="edit-area-${c.id}">
                            <textarea class="co-edit-textarea" id="input-${c.id}">${escapeHtml(c.content)}</textarea>
                            <div id="edit-error-${c.id}" class="hidden" style="color: #dc3545; font-size: 0.8rem; margin-bottom: 5px;"></div>
                            <div class="co-edit-controls">
                                <button class="gym-btn gym-btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editCommentCancel('${c.id}')">${JS_RESOURCES.btnCancel}</button>
                                <button class="gym-btn gym-btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="editCommentSave('${c.id}')">${JS_RESOURCES.btnSave}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            list.insertAdjacentHTML('afterbegin', html);
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- EDIT LOGIC ---
        window.editCommentStart = function(id) {
            const textView = document.getElementById(`text-${id}`);
            const editView = document.getElementById(`edit-area-${id}`);
            const errView = document.getElementById(`edit-error-${id}`);

            if(textView && editView) {
                textView.classList.add('hidden');
                editView.classList.remove('hidden');
                if(errView) {
                    errView.innerText = "";
                    errView.classList.add('hidden');
                }
            }
        };

        window.editCommentCancel = function(id) {
            const textView = document.getElementById(`text-${id}`);
            const editView = document.getElementById(`edit-area-${id}`);
            const inputEl = document.getElementById(`input-${id}`);

            if(textView && editView) {
                textView.classList.remove('hidden');
                editView.classList.add('hidden');
                if(inputEl) inputEl.value = textView.innerText;
            }
        };

        window.editCommentSave = async function(id) {
            const inputEl = document.getElementById(`input-${id}`);
            const errEl = document.getElementById(`edit-error-${id}`);
            const newContent = inputEl.value.trim();

            if(errEl) {
                errEl.innerText = "";
                errEl.classList.add('hidden');
            }

            if (!newContent) {
                if(errEl) {
                    errEl.innerText = JS_RESOURCES.msgEmptyComment;
                    errEl.classList.remove('hidden');
                }
                return;
            }

            const formData = new FormData();
            formData.append('commentId', id);
            formData.append('newContent', newContent);

            try {
                const res = await fetch('/Comment/EditComment', { method: 'POST', body: formData });
                const data = await res.json();

                if (res.ok && data.success) {
                    document.getElementById(`text-${id}`).innerText = newContent;
                    editCommentCancel(id);
                } else {
                    if (data.errors && data.errors.NewContent) {
                         if(errEl) {
                             const msg = Array.isArray(data.errors.NewContent) ? data.errors.NewContent[0] : data.errors.NewContent;
                             errEl.innerText = msg;
                             errEl.classList.remove('hidden');
                         }
                    } else {
                        if(typeof alertify !== 'undefined') alertify.error(data.message || JS_RESOURCES.msgErrorUpdate);
                    }
                }
            } catch (e) { console.error(e); }
        };

        // --- DELETE LOGIC (UPDATED WITH ALERTIFY) ---
        window.deleteCommentNode = function(btn, id) {
            alertify.confirm(
                'Gymify',
                JS_RESOURCES.msgConfirmDelete,
                async function() {
                    // === OK Pressed ===
                    const originalText = btn.innerText;
                    btn.disabled = true;
                    btn.innerText = "...";

                    const item = document.getElementById('comment-el-' + id) || btn.closest('.co-item');

                    try {
                        const res = await fetch(`/Comment/DeleteComment?commentId=${id}`, { method: 'POST' });
                        if(res.ok) {
                            // Анімація видалення
                            item.style.transition = "all 0.3s";
                            item.style.opacity = "0";
                            item.style.transform = "scale(0.95)";

                            setTimeout(() => {
                                item.remove();
                                // Перевіряємо, чи список не став порожнім
                                if (list.querySelectorAll('.co-item').length === 0 && emptyMsg) {
                                    emptyMsg.style.display = 'block';
                                }
                            }, 300);

                        } else {
                            if(typeof alertify !== 'undefined') alertify.error(JS_RESOURCES.msgErrorDelete);
                            // Повертаємо кнопку, якщо помилка
                            btn.disabled = false;
                            btn.innerText = originalText;
                        }
                    } catch(e) {
                        console.error(e);
                        btn.disabled = false;
                        btn.innerText = originalText;
                        if(typeof alertify !== 'undefined') alertify.error(JS_RESOURCES.msgErrorDelete);
                    }
                },
                function() {
                    // Cancel Pressed
                }
            ).set('labels', {ok:'Yes', cancel:'No'});
        };
    })();
</script>